<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <link rel="stylesheet" href="custom.css">
    <script src="const.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

    <!-- <link rel="stylesheet" href="bootstrap-icons.css">
    <link rel="stylesheet" href="bootstrap.min.css">
    <script src="lodash.js"></script>
    <script src="jquery-3.6.0.min.js"></script>
    <script src="vue.js"></script> -->

    <title>狼人殺 主持人救星</title>
</head>

<body>
    <div id="settingApp" class="day" style="overflow-x: hidden; background-color: rgb(47 47 47);">
        <div class="container-sm lock-mobile-width bg-color-2" style="min-height: 100%;">
            <div class="row">
                <div style="height: 35px;"></div>
                <div class="text-center flex-center" style="font-size: 1.5rem;">
                    【狼人殺 面殺救星✊🏻】
                </div>
                <div class="col-1"></div>
                <div class="col-11 p-2" style="font-size: 0.7rem; color: #404040;">
                    這是提供狼人殺主持人可以<br>
                    <span class="under-line">方便紀錄</span> 以及
                    <span class="under-line">避免出錯</span>的小幫手
                    <br> 之後會推出給玩家使用的<span class="under-line">玩家筆記</span>小幫手
                    <br>敬請期待～
                </div>
                <div style="height: 20px;"></div>

                <div class="container">
                    <div class="row">
                        <div class="row text-center flex-center">
                            <div class="col-6" style="font-size: 1.2rem;">遊戲人數</div>
                            <div class="col-6 row">
                                <count-btn v-model="playerNum" :max="15" :min="6"></count-btn>
                            </div>
                        </div>
                        <div style="height: 10px;"></div>
                        <div style="height: 10px;"></div>

                        <div v-if="_.get(recommendedSetting,[playerNum], []).length > 0" class="row flex-center">
                            <div class="col-6" style="font-size: 1.2rem;">推薦組合：</div>
                            <div class="col-6 row"></div>
                        </div>

                        <div v-for="(setting, index) in recommendedSetting[playerNum]" v-on:click="setChooseSet(index)">
                            <board class="board bg-color-1 p-2 m-2" :class="{'selected': chooseSet == index}" :setting="setting" :role-card="roleCard"></board>
                        </div>

                        <div class="row flex-center">
                            <div class="col-6" style="font-size: 1.2rem;">自訂：</div>
                            <div class="col-6 row"></div>
                        </div>

                        <div v-on:click="setChooseSet('custom')">
                            <div class="board bg-color-1 p-2 m-2" :class="{'selected': chooseSet == 'custom'}">
                                <div class="row text-center flex-center">
                                    <div style="text-align: left;">【狼人陣營】</div>
                                    <div class="col-6">狼王</div>
                                    <div class="col-6">
                                        <count-btn v-model="roleNum.werewolvesKing" :disable-add="disableAdd"></count-btn>
                                    </div>

                                    <div style="height: 10px;"></div>

                                    <div class="col-6">狼人</div>
                                    <div class="col-6">
                                        <count-btn v-model="roleNum.werewolves" :max="playerNum" :disable-add="disableAdd"></count-btn>
                                    </div>

                                    <div style="height: 10px;"></div>
                                    <div style="height: 10px;"></div>


                                    <!-- <div class="col-6">白狼王</div>
                                    <div class="col-6">
                                        開發中敬請期待
                                    </div>

                                    <div class="col-6">狼美人</div>
                                    <div class="col-6">
                                        開發中敬請期待
                                    </div> -->
                                    <div style="height: 10px;"></div>


                                    <div style="text-align: left;">【好人陣營】</div>
                                    <div class="col-6">預言家</div>
                                    <div class="col-6">
                                        <count-btn v-model="roleNum.seer" :disable-add="disableAdd"></count-btn>
                                    </div>

                                    <div style="height: 10px;"></div>


                                    <div class="col-6">女巫</div>
                                    <div class="col-6">
                                        <count-btn v-model="roleNum.witch" :disable-add="disableAdd"></count-btn>
                                    </div>
                                    <div class="col-2">

                                    </div>
                                    <div class="col-10">
                                        <div style="text-align: left;">
                                            <div>
                                                <input id="wR1" type="radio" v-model="witchRule" value="onlyFirst" :disabled="roleNum.witch == 0"><label for="wR1"><span style="font-size: 0.7rem;">&ensp;第一晚可自救</span></label>
                                            </div>
                                            <div>
                                                <input id="wR2" type="radio" v-model="witchRule" value="canNot" :disabled="roleNum.witch == 0"><label for="wR2"><span style="font-size: 0.7rem;">&ensp;全程不可自救</span></label>
                                            </div>
                                            <div>
                                                <input id="wR3" type="radio" v-model="witchRule" value="allCan" :disabled="roleNum.witch == 0"><label for="wR3"><span style="font-size: 0.7rem;">&ensp;全程可自救</span></label>
                                            </div>
                                        </div>
                                    </div>

                                    <div style="height: 10px;"></div>

                                    <div class="col-6">獵人</div>
                                    <div class="col-6">
                                        <count-btn v-model="roleNum.hunter" :disable-add="disableAdd"></count-btn>
                                    </div>

                                    <div style="height: 10px;"></div>

                                    <div class="col-6">騎士</div>
                                    <div class="col-6">
                                        <count-btn v-model="roleNum.knight" :disable-add="disableAdd"></count-btn>
                                    </div>
                                    <div style="height: 10px;"></div>


                                    <!-- <div class="col-6">守衛</div>
                                    <div class="col-6">
                                        開發中敬啟期待
                                    </div>

                                    <div class="col-6">魔術師</div>
                                    <div class="col-6">
                                        開發中敬請期待
                                    </div> -->

                                    <div class="col-6">平民</div>
                                    <div class="col-6">
                                        {{villagers}}
                                    </div>
                                </div>

                                <br>
                                <div style="color: gray;">
                                    <input type="checkbox" disabled="true" v-model="hasSheriff">警長（開發中）
                                    <br>
                                    <input type="radio" v-model="sheriffRule" value="1" :disabled="!hasSheriff"><span style="font-size: 0.7rem;">單爆吞警徽</span>
                                    <br>
                                    <input type="radio" v-model="sheriffRule" value="2" :disabled="!hasSheriff"><span style="font-size: 0.7rem;">雙爆吞警徽</span>
                                </div>
                                <div style="height: 10px;"></div>

                                【獲勝條件】
                                <br>
                                <input id="vC1" type="radio" v-model="victoryCon" value="killSide"><label for="vC1">屠邊<span style="font-size: 0.7rem;">（神職全死 或 平民全死）</span></label>
                                <br>
                                <input id="vC2" type="radio" v-model="victoryCon" value="killAll"><label for="vC2">屠城<span style="font-size: 0.7rem;">（好人全死）</span></label>
                            </div>
                        </div>
                        <div style="height: 60px;"></div>

                        <div class="submit-bar lock-mobile-width p-2">
                            <button class="btn-submit text-center btn-color-green" @click="submit">開&ensp;始</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="app" v-if="isShow" :class="timeStatus" style="background-color: rgb(47 47 47);">
        <div class="header-bar text-center lock-mobile-width bg-color-2">
            <div class="container-sm">
                <transition name="slide-fade" mode="out-in">
                    <div v-if="hostMessage" :key="hostMessage" class="host-message text-center">
                        <div class="host-text-arrow"></div>
                        <div v-html="hostMessage"></div>
                    </div>
                    <div v-if="!hostMessage" style="height: 80px;"></div>
                </transition>
                <div class="judge-icon">
                    <i class="bi bi-person-fill"></i>
                </div>
                <div v-if="hostTips" :key="hostTips" class="host-tips text-center" v-html="hostTips">
                </div>
            </div>
        </div>
        <div class="function-bar lock-mobile-width bg-color-2">
            <div class="function-bar-wapper">
                <button v-for="btn in functionBarBtns" class="btn-color-green" v-show="btn.isShow" :class="btn.class" @click="btn.click" :disabled="btn.disable" v-html="btn.html"></button>
                <div style="width: 25px;"></div>
            </div>
            <!-- todo: fix animation -->
            <!-- <div id="maskNavBar" class="function-bar-mask"></div> -->
        </div>

        <div class="container-sm lock-mobile-width bg-color-1" style="min-height: 100%;">
            <div class="row">
                <!-- for Complement header height -->
                <div style="height: 210px;"></div>

                <div class="container">
                    <div class="row g-3">
                        <player-btn v-for="(player, index) in players" :player="player" :role-card="roleCard" :disable-btn="disableBtn" :kill-tag="tonight.killTag" v-model="selected"></player-btn>
                    </div>
                </div>
                <!-- for Complement bottom bar height -->
                <div style="height: 70px;"></div>
                <br>
            </div>
        </div>
        <div class="bottom-bar lock-mobile-width bg-color-2">
            <button class="next-btn btn-color-green" v-on:click="back()"><i class="bi bi-arrow-counterclockwise"></i>還原</button>
            <button class="next-btn btn-color-green" v-on:click="next()" :disabled="disableNext && selected.length == 0">下一步 <i class="bi bi-arrow-right-circle-fill"></i></button>
        </div>
        <!-- 使用解藥 -->
        <modal v-show="showModal == 'usedAntidote'" @close="showModal = false">
            <div slot="header">
                使用<span style="color: #1dd1a1;">解藥？</span>
            </div>
            <div slot="footer">
                <button class="modal-btn" v-on:click="witchSave(true)">是</button>
                <button class="modal-btn" v-on:click="witchSave(false)">否</button>
            </div>
        </modal>
        <!-- 使用毒藥 -->
        <modal v-show="showModal == 'usedPoison'" @close="showModal = false">
            <div slot="header">
                使用<span style="color: #9b59b6;">毒藥？</span>
            </div>
            <div slot="footer">
                <button class="modal-btn" v-on:click="poisonAsk(true)">是</button>
                <button class="modal-btn" v-on:click="poisonAsk(false)">否</button>
            </div>
        </modal>
        <!-- 騎士對決 -->
        <modal v-show="showModal == 'knightBattle'" @close="showModal = false">
            <div v-show="stage != 'speaking'" slot="header">騎士查驗</div>
            <div v-show="stage == 'speaking'" slot="header">請選擇騎士查驗對象</div>
            <div v-show="stage == 'speaking'" slot="body">
                <div v-for="(player, key) in players" class="col-4" style="display: inline-block;" v-on:click="function() { if(!player.isAlive || key == _.findKey(players, knightPlayer)) {return;} knightChoose = key; }">
                    <div class="modal-player-btn" :class="{'selected': knightChoose == key, 'disable': !player.isAlive || key == _.findKey(players, knightPlayer)}">
                        {{ key }}
                    </div>
                </div>
                <div style="height: 15px;"></div>
                <div style="background: linear-gradient(rgba(255, 255, 255, 0), rgb(255, 255, 255, 0.8), rgb(255, 255, 255, 0.97), rgb(255, 255, 255, 1));
                position: absolute;
                bottom: 77px;
                left: 0px;
                width: 100%;
                height: 30px;"></div>
            </div>
            <div v-show="stage != 'speaking'" slot="body" class="text-center">
                僅能在白天發言階段使用。
            </div>
            <div v-show="stage == 'speaking'" slot="footer" class="text-center">
                <button class="modal-btn" v-on:click="knightBattle(knightChoose)">確定</button>
                <button class="modal-btn" v-on:click="showModal = false">取消</button>
            </div>
            <div v-show="stage != 'speaking'" slot="footer" class="text-center">
                <button class="modal-btn" v-on:click="showModal = false">關閉</button>
            </div>
        </modal>
        <!-- 狼人自爆 -->
        <modal v-if="showModal == 'wolfKillSelf'" @close="showModal = false">
            <div v-show="stage != 'speaking'" slot="header">狼人自爆</div>
            <div v-show="stage == 'speaking'" slot="header">請選擇自爆的狼人</div>
            <div v-show="stage == 'speaking'" slot="body">
                <div v-for="(player, key) in players" class="col-4" v-if="player.isAlive && _.get(roleCard, [player.identity, 'camp'], '') === 'bad'" style="display: inline-block;" v-on:click="wolfKillSelfChoose = key">
                    <div class="modal-player-btn" :class="{'selected': wolfKillSelfChoose == key}">
                        {{ key }}
                    </div>
                </div>
                <br>
            </div>
            <div v-show="stage != 'speaking'" slot="body" class="text-center">
                僅能在白天發言階段使用。
            </div>
            <div v-show="stage == 'speaking'" slot="footer" class="text-center">
                <button class="modal-btn" v-on:click="wolfKillSelf(wolfKillSelfChoose)">確定</button>
                <button class="modal-btn" v-on:click="showModal = false">取消</button>
            </div>
            <div v-show="stage != 'speaking'" slot="footer" class="text-center">
                <button class="modal-btn" v-on:click="showModal = false">關閉</button>
            </div>
        </modal>
        <!-- 發言順序 -->
        <modal v-if="showModal == 'speakingModal'" @close="showModal = false">
            <div slot="header">誰先發言？</div>
            <div slot="body">
                <div v-for="(player, key) in players" class="col-2" style="display: inline-block;" v-on:click="function() { if(!player.isAlive) {return;} today.firstSpeak = key; }">
                    <div class="modal-player-btn" style="width: 30px; height: 30px;" :class="{'selected': today.firstSpeak == key, 'disable': !player.isAlive}">
                        {{ key }}
                    </div>
                </div>
                <div class="row m-2">
                    <div class="col-6">
                        <div class="modal-player-btn" :class="{'selected': today.speakingDirection == 'right'}" style="width: 100%; height: 50px; border-radius: 50px;" @click="today.speakingDirection = 'right'">
                            逆時針
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="modal-player-btn" :class="{'selected': today.speakingDirection == 'left'}" style="width: 100%; height: 50px; border-radius: 50px;" @click="today.speakingDirection = 'left'">
                            順時針
                        </div>
                    </div>
                </div>
                <div style="height: 10px;"></div>
                <div style="background: linear-gradient(rgba(255, 255, 255, 0), rgb(255, 255, 255, 0.8), rgb(255, 255, 255, 0.97), rgb(255, 255, 255, 1));
                position: absolute;
                bottom: 77px;
                left: 0px;
                width: 100%;
                height: 30px;"></div>
            </div>
            <div slot="footer" class="text-center">
                <button id="randomBtn" class="modal-btn" :disabled="dicing" v-on:click="randomOrder()"><span v-html="dice"></span>&nbsp抽籤</button>
                <button id="orderBtn" class="modal-btn" :disabled="!today.firstSpeak || !today.speakingDirection || dicing" v-on:click="next()">確定</button>
            </div>
        </modal>

        <!-- 遊戲結束 -->
        <modal v-if="showModal == 'gameOver'" @close="showModal = false">
            <div slot="header">{{gameOverTitle}}</div>
            <div slot="body" class="text-center">
                喜歡這個程式嗎？<br> 是否願意贊助我們喝杯咖啡？
            </div>
            <div slot="footer" class="flex-center">
                <a href=""></a>
                <a class="pay-img" href="https://www.jkopay.com/transfer?j=Transfer:900533530">
                </a>
            </div>
        </modal>
    </div>
</body>

</html>


<!-- template for the modal component -->
<script type="text/x-template" id="modal-template">
    <transition name="modal">
        <div class="modal-mask">
            <div class="modal-wrapper">
                <div class="modal-container">
                    <div class="modal-header-custom text-center p-1">
                        <slot name="header">
                            <!-- default header -->
                        </slot>
                    </div>
                    <div class="modal-body-custom p-1">
                        <slot name="body">
                            <!-- default body -->
                        </slot>
                    </div>
                    <div class="modal-footer-custom">
                        <slot name="footer">
                            <!-- default footer -->
                        </slot>
                    </div>
                </div>
            </div>
        </div>
    </transition>
</script>
<script>
    Vue.component("modal", {
        template: "#modal-template"
    });
</script>

<!-- template for count btn -->
<script type="text/x-template" id="countBtn">
    <div class="flex-center">
        <div class="col-4 p-0">
            <button class="count-btn btn-color-green" @click="subtract" :disabled="value <= min">
                <i class="bi bi-dash"></i>
            </button>
        </div>
        <div class="col-4 p-0">{{value}}</div>
        <div class="col-4 p-0">
            <button class="count-btn btn-color-green" @click="add" :disabled="value >= max || disableAdd">
                <i class="bi bi-plus"></i>
            </button>
        </div>
    </div>
</script>
<script>
    Vue.component("count-btn", {
        template: "#countBtn",
        props: {
            value: {
                type: Number,
                default: 12,
            },
            max: {
                type: Number,
                default: 1,
            },
            min: {
                type: Number,
                default: 0,
            },
            disableAdd: {
                type: Boolean,
                default: false,
            }
        },
        methods: {
            add: function() {
                this.$emit('input', this.value + 1);
            },
            subtract: function() {
                this.$emit('input', this.value - 1);
            }
        }
    });
</script>


<!-- template for board-template -->
<script type="text/x-template" id="board-template">
    <div class="">
        {{setting.title}}
        <div style="display: flex;">
            <div v-for="(num, role) in setting.roleNum" v-if="num > 0" style="display: contents;">
                <div class="role-dot-tag" :class="_.get(roleCard, [role, 'position'], '') + '-bg-color'">{{roleCard[role].shortName}}</div>
                <!-- <div v-for="i in (num-1)" class="role-dot-tag" :class="_.get(roleCard, [role, 'position'], '') + '-background-color'" style="margin-left: -20px;">{{roleCard[role].shortName}}</div> -->
                <div v-if="num >= 2" style="width: 20px;
                            display: flex;
                            place-content: center flex-start;
                            align-items: flex-end;
                            justify-content: flex-start;
                            align-content: center;">
                    <span style="font-size: 0.5rem;">x{{num}}</span>
                </div>
            </div>
        </div>
        <div style="height: 5px;"></div>
        <div v-if="showSheriffRule" class="rule-line">
            ・{{showSheriffRule}}
        </div>
        <div v-if="showWitchRule" class="rule-line">
            ・{{showWitchRule}}
        </div>
        <div v-if="showVictoryCon" class="rule-line">
            ・{{showVictoryCon}}
        </div>
    </div>
</script>
<script>
    Vue.component("board", {
        template: "#board-template",
        props: {
            'setting': {
                type: Object,
                default: function() {
                    return {};
                }
            },
            'roleCard': {
                type: Object,
                default: function() {
                    return {};
                }
            }
        },
        computed: {
            showSheriffRule: function() {
                if (!this.setting.hasSheriff) {
                    return '無警長';
                }
                var rule = {
                    '1': '有警長（單爆吞警徽）',
                    '2': '有警長（雙爆吞警徽）',
                }

                return rule[_.get(this, ['setting', 'sheriffRule'], '2')];
            },
            showWitchRule: function() {
                if (this.setting.roleNum.witch <= 0) {
                    return '';
                }

                var result = '';
                switch (this.setting.witchRule) {
                    case WITCH_SELF_HELP_CON.ONLY_FIRST:
                        return '女巫第一晚可自救';
                    case WITCH_SELF_HELP_CON.CAN_NOT:
                        return '女巫全程不可自救';
                    case WITCH_SELF_HELP_CON.ALL_CAN:
                        return '女巫全程可自救';
                    default:
                        break;
                }
                return '';
            },
            showVictoryCon: function() {
                return this.setting.victoryCon == VICTORY_CON.KILL_SIDE ? '屠邊局' : '屠城局';
            }
        }
    });
</script>

<!-- template for the player button component -->
<script type="text/x-template" id="playerBtnTemp">
    <div class="player-btn-contanier text-center text-clould col-4" :class="{'animation': isAnimation, 'selected-btn': isSelected}" v-on:click="btnClick(player)">
        <div class="player-btn p-2" :class="{'selected': isSelected}">
            <div>
                <span class="number">{{ player.key }}</span><br>
                <span style="font-size: 0.8rem;">({{ player.name }})</span><br>
            </div>
        </div>
        <div v-if="!player.isAlive" class="death-tag p-2">
            <div></div>
        </div>
        <div v-if="!!_.get(this.killTag, [this.player.key], false)" class="kill-tag p-2">
            <div></div>
        </div>
        <div v-if="player.identity != ''" class="role-tag p-2">
            <div>
                <i class="bi bi-flag-fill" :class="_.get(roleCard, [player.identity, 'position'], '') + '-color'"></i>&nbsp{{ _.get(roleCard, [player.identity, 'text'], '')}}
            </div>
        </div>
    </div>
</script>
<script>
    Vue.component("player-btn", {
        template: "#playerBtnTemp",
        props: {
            value: {
                isRequired: true,
                default: [],
            },
            player: {
                isRequired: true,
            },
            roleCard: {
                isRequired: true,
            },
            disableBtn: {
                isRequired: true,
            },
            killTag: {
                isRequired: true,
            },
        },
        data: function() {
            return {
                isAnimation: false,
            };
        },
        computed: {
            isSelected: function() {
                return _.indexOf(this.value, this.player.key) >= 0;
            },
        },
        methods: {
            btnClick: function() {
                if (this.disableBtn || !this.player.isAlive) {
                    return;
                }

                this.isAnimation = true;
                setTimeout(() => {
                    this.isAnimation = false;
                }, 100);

                var selected = _.cloneDeep(this.value);

                if (this.isSelected) {
                    _.pull(selected, this.player.key)
                } else {
                    selected.push(this.player.key);
                }
                this.$emit('input', selected);
            },

        },
    });
</script>

<script>
    var roleNum = {
        'werewolvesKing': 1,
        'werewolves': 3,
        'seer': 1,
        'witch': 1,
        'hunter': 1,
        'knight': 1,
    }

    var temp = [];
    var logArr = [];

    var logLang = {
        'wolfKill': '狼刀殺',
        'witchKill': '女巫毒殺',
        'good': '好人',
        'bad': '壞人',
    }

    var settingApp = new Vue({
        el: '#settingApp',
        data: {
            roleCard: roleCard,
            recommendedSetting: recommendedSetting,
            chooseSet: 0,
            playerNum: 12,
            roleNum: {
                'werewolvesKing': 1,
                'werewolves': 3,
                'seer': 1,
                'witch': 1,
                'hunter': 1,
                'knight': 1,
                'villagers': 4,
            },
            hasSheriff: false,
            sheriffRule: '',
            witchRule: WITCH_SELF_HELP_CON.ONLY_FIRST,
            victoryCon: VICTORY_CON.KILL_SIDE,
        },
        created: function() {
            window.onbeforeunload = function() {
                return false;
            }

            // 禁止縮放
            window.onload = () => {
                document.addEventListener('touchstart', (event) => {
                    if (event.touches.length > 1) {
                        event.preventDefault();
                    }
                }, {
                    passive: false
                });

                let lastTouchEnd = 0;
                document.addEventListener('touchend', (event) => {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);

                document.addEventListener('touchmove', function(event) {
                    event = event.originalEvent || event;
                    if (event.scale > 1) {
                        event.preventDefault();
                    }
                }, false);

                document.addEventListener('gesturestart', function(e) {
                    e.preventDefault();
                });
            }
        },
        watch: {
            playerNum: function(val) {
                var defaultData = _.get(this, ['recommendedSetting', val, 0], {});
                if (_.size(defaultData) <= 0) {
                    this.chooseSet = 'custom';
                    return;
                }
                this.chooseSet = '0';
                this.roleNum = defaultData.roleNum;
                this.hasSheriff = defaultData.hasSheriff;
                this.sheriffRule = defaultData.sheriffRule;
                this.witchRule = defaultData.witchRule;
                this.victoryCon = defaultData.victoryCon;
            }
        },
        methods: {
            updateData: function(name, value) {
                console.log(name);
                console.log(value);
                this[name] = value;
            },
            setChooseSet: function(index) {
                this.chooseSet = index;
            },
            submit: function() {
                if (this.chooseSet == 'custom') {
                    app.playerNum = _.cloneDeep(this.playerNum);
                    app.roleNum = _.cloneDeep(this.roleNum);
                    app.witchRule = _.cloneDeep(this.witchRule);
                    app.victoryCon = _.cloneDeep(this.victoryCon);
                } else {
                    var _this = this;
                    var chooseData = _.get(this, ['recommendedSetting', this.playerNum, this.chooseSet], {});

                    app.playerNum = _.cloneDeep(this.playerNum);
                    app.roleNum = _.cloneDeep(chooseData.roleNum);
                    app.witchRule = _.cloneDeep(chooseData.witchRule);
                    app.victoryCon = _.cloneDeep(chooseData.victoryCon);
                }

                $('#settingApp').hide();
                app.isShow = true;
                app.initPlayer();
            },
        },
        computed: {
            disableAdd: function() {
                var roleTotalNum = this.werewolvesKing +
                    this.werewolves +
                    this.seer +
                    this.witch +
                    this.hunter +
                    this.knight;

                return (roleTotalNum + 1) >= this.playerNum ? true : false;
            },
            villagers: function() {
                return this.playerNum - _.sum(_.values(_.reject(this.roleNum, function(o, key) {
                    return key == 'villagers';
                })));
            }
        }
    });


    var app = new Vue({
        el: '#app',
        data: {
            isShow: false,
            roleCard: roleCard,
            isSpeakingStage: false,
            stage: '',
            timeStatus: 'day',
            day: 1,
            hostMessage: '（這裡會顯示你要說的話）',
            hostTips: '感謝你願意當辛苦的主持人<br>（請按右下角【下一步】開始）',
            actionNum: 0,
            selected: [],
            selectQuota: 0,
            selectAutoNext: false,
            disableBtn: true,
            disableNext: false,

            tonight: {
                killTag: {},
                killbyHunter: '',
                killbyWerewolvesKing: '',
                killedByWerewolves: '',
                killedByWitch: '',
                haveUsedAntidote: false,
                verifyTarget: '',
                verifyResult: '',
            },
            today: {
                killbyHunter: '',
                killbyWerewolvesKing: '',
                firstSpeak: '',
                speakIndex: 0,
                speakingDirection: '', // left: 順時鐘, right: 逆時鐘
                killedByVote: '',
                PKRoundNum: 0,
            },
            clickPKFlag: false,
            passSkillFlag: false,
            isUsedAntidote: false,
            isUsedPoison: false,
            tonightWitchSave: null,
            witchRule: WITCH_SELF_HELP_CON.ONLY_FIRST,

            tonightVerify: null,

            knightChoose: '',
            knightIsUsedSkill: false,

            wolfKillSelfChoose: '',

            showTimer: false,
            timer: 0,
            timerInterval: null,

            dice: '<i class="bi bi-dice-6-fill"></i>',
            dicing: false,

            showModal: '',
            gameOverTitle: '',

            playerNum: 0,
            players: {},
            roleNum: {
                'werewolvesKing': 0,
                'werewolves': 0,
                'seer': 0,
                'witch': 0,
                'hunter': 0,
                'knight': 0,
            },
            rolePlayerIndex: {
                'seer': 0,
                'witch': 0,
                'hunter': 0,
                'knight': 0,
            },

            victoryCon: VICTORY_CON.KILL_SIDE,
        },
        created: function() {
            temp.push(_.cloneDeep(this.$data));
        },
        mounted: function() {
            // todo: 優化，使用vue on scorll
            // var element = document.getElementsByClassName('function-bar')[0];
            // element.addEventListener("scroll", function(event) {
            //     var a = $(this).scrollLeft();
            //     var b = $(this).width();
            //     var c = $('.function-bar-wapper').width();
            //     if ((a + b + 50) > c) {
            //         $('#maskNavBar').hide();
            //     } else {
            //         $('#maskNavBar').show();
            //     }
            // }, false);

            // this.$nextTick(() => {
            //     testInit();
            // })
        },
        watch: {
            'selected': function(val, oldVal) {
                if (val.length == 0) {
                    return;
                }

                if (this.selected.length > this.selectQuota) {
                    this.selected = _.drop(this.selected);
                }

                if (val.length == this.selectQuota) {
                    if (this.selectAutoNext) {
                        this.next();
                    }
                }
            }
        },
        methods: {
            initPlayer: function() {
                for (var i = 1; i <= this.playerNum; i++) {
                    this.players[i] = {
                        'key': i,
                        'name': i + '號玩家',
                        'identity': '',
                        'isAlive': true,
                    }
                }
            },
            next: function() {
                var backupData = _.cloneDeep(this.$data);
                var nowRunDown = this.runDown();

                if (typeof(nowRunDown.action) === 'function') {
                    try {
                        if (nowRunDown.action() === 'pass') {
                            this.actionNum += 1;
                            this.next();
                            return;
                        };
                    } catch (e) {
                        console.log('error at next: ', e);
                        return;
                    }
                }
                this.hostMessage = nowRunDown.messageHtml;
                this.hostTips = nowRunDown.tipsHtml;
                if (_.has(nowRunDown, ['modal'])) {
                    this.showModal = _.get(nowRunDown, ['modal'], false);
                }
                this.actionNum += 1;
                this.backup(backupData);
            },
            backup: function(backupData) {
                if (temp.length > 20) {
                    temp = _.drop(temp);
                }
                temp.push(backupData);
            },
            back: function() {
                if (temp.length <= 1) {
                    return;
                }

                var previousData = _.last(temp);
                temp.pop();
                _.forEach(this.$data, (value, key) => {
                    this.$data[key] = previousData[key]
                });
                this.selected = [];
                this.clickPKFlag = false;
                this.passSkillFlag = false;
            },
            pkRound: function() {
                this.clickPKFlag = true;
                this.next();
            },
            knightBattle: function(target) {
                if (this.knightIsUsedSkill) {
                    return;
                }
                var knightPlayerKey = _.findKey(this.players, this.knightPlayer);
                if (target == '' || target == this.knightPlayer || !this.players[target].isAlive) {
                    return;
                }
                this.showModal = false;
                var backupData = _.cloneDeep(this.$data);

                this.showTimer = false;
                var targetIdentity = _.get(this, ['players', target, 'identity'], '');
                var targetCamp = _.get(roleCard, [targetIdentity, 'camp'], '');
                if (targetCamp == 'bad') {
                    this.hostMessage = target + '號 是狼人！<br>準備進入黑夜'
                    this.setIsAlive(target, false);
                    this.resetNightData();
                    this.resetDayData();
                    this.actionNum = 0;
                    this.day += 1;
                } else if (targetCamp == 'good') {
                    this.hostMessage = target + '號 不是狼人！<br>' + knightPlayerKey + '號 騎士以死謝罪'
                    this.setIsAlive(knightPlayerKey, false);
                }
                this.knightIsUsedSkill = true;
                this.backup(backupData);
            },
            wolfKillSelf: function(target) {
                this.showModal = false;
                var backupData = _.cloneDeep(this.$data);

                if (this.players[target].identity == 'werewolvesKing') {
                    this.hostMessage = target + '號狼人自爆<br>請使用角色技能';
                    this.disableBtn = false;
                    this.stage = 'usingSkill';
                    this.actionNum = 43;
                    this.setIsAlive(target, false);
                    this.backup(backupData);
                    return;
                } else {
                    this.hostMessage = target + '號狼人自爆<br>中止所有發言直接進入黑夜';
                }
                this.setIsAlive(target, false);
                this.resetNightData();
                this.resetDayData();
                this.actionNum = 0;
                this.day += 1;

                this.backup(backupData);
            },
            setSelectQuota: function(quota) {
                this.selectQuota = quota;
            },
            setIdentity: function(role) {
                try {
                    if (this.selected.length != this.selectQuota) {
                        throw '數量不對';
                    }

                    _.forEach(this.selected, (key) => {
                        if (this.players[key].identity !== '') {
                            throw '已經設定角色';
                        } else {
                            this.players[key].identity = role;
                        }
                    });

                    if (_.has(this.rolePlayerIndex, role)) {
                        this.rolePlayerIndex[role] = this.selected[0];
                    }

                    this.selected = [];
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            btnClick: function(index, player) {
                if (!player.isAlive) {
                    return;
                }
                $('#' + index).trigger('click');
            },
            isSelected: function(index) {
                return _.indexOf(this.selected, index) >= 0;
            },
            // kill相關
            setKillTag: function(type = '', canPass = false) {
                try {
                    if (canPass && this.selected.length == 0) {
                        return;
                    }

                    if (this.selected.length != 1) {
                        throw '數量不對';
                    }
                    if (type == '') {
                        throw 'Type不對';
                    }
                    this.tonight.killTag[this.selected[0]] = type;
                    this.selected = [];
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            executeKillTag: function() {
                _.forEach(this.tonight.killTag, (deadType, index) => {
                    if (typeof(this[deadType] === 'function')) {
                        this[deadType](index);
                    }
                });
            },
            setDefaultFirstSpeaker: function() {
                var death = _.keys(this.tonight.killTag);

                if (death.length == 0) {
                    return;
                }
                var first = _.toInteger(_.get(death, [0], 0)) + 1;
                var totalPlayers = _.size(this.players);

                for (var i = 0; i < totalPlayers; i++) {
                    var index = (first + i) % totalPlayers <= 0 ? (first + i) % totalPlayers + totalPlayers : (first + i) % totalPlayers;
                    if (this.players[index].isAlive == true) {
                        this.today.speakingDirection = 'left';
                        this.today.firstSpeak = index;
                        return;
                    }
                }
            },
            wolfKill: function(target) {
                try {
                    this.tonight.killedByWerewolves = target;
                    this.setIsAlive(target, false);
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            witchKill: function(target) {
                try {
                    this.tonight.killedByWitch = target;
                    this.isUsedPoison = true;
                    this.setIsAlive(target, false);
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            voteKill: function() {
                try {
                    if (this.selected.length != 1) {
                        throw '數量不對';
                    }
                    this.today.killedByVote = this.selected[0];
                    this.setIsAlive(this.today.killedByVote, false);
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            hunterKill: function(time = 'night') {
                try {
                    if (this.selected.length != 1) {
                        throw '數量不對';
                    }
                    if (time == 'night') {
                        this.tonight.killbyHunter = this.selected[0];
                    } else if (time == 'day') {
                        this.today.killbyHunter = this.selected[0];
                    }
                    this.setIsAlive(this.selected[0], false);
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            werewolvesKingKill: function(time = 'night') {
                try {
                    if (this.selected.length != 1) {
                        throw '數量不對';
                    }
                    if (time == 'night') {
                        this.tonight.killbyWerewolvesKing = this.selected[0];
                    } else if (time == 'day') {
                        this.today.killbyWerewolvesKing = this.selected[0];
                    }
                    this.setIsAlive(this.selected[0], false);
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            witchSave: function(boolean) {
                this.tonight.haveUsedAntidote = boolean;
                this.next();
            },
            poisonAsk: function(boolean) {
                var backupData = _.cloneDeep(this.$data);
                if (boolean) {
                    this.showModal = false;
                    this.hostTips = '（請點選毒藥使用玩家）';
                    this.backup(backupData);
                    return;
                }
                this.next();
            },
            randomOrder: function() {
                var direction = _.sample(['left', 'right']);
                var alivePlayers = _.map(_.filter(this.players, (player) => {
                    return player.isAlive;
                }), (player) => {
                    return player.key;
                });
                this.dicing = true;

                var diceArr = [
                    '<i class="bi bi-dice-1"></i>',
                    '<i class="bi bi-dice-2"></i>',
                    '<i class="bi bi-dice-3"></i>',
                    '<i class="bi bi-dice-4"></i>',
                    '<i class="bi bi-dice-5"></i>',
                    '<i class="bi bi-dice-6"></i>',
                    '<i class="bi bi-dice-1-fill"></i>',
                    '<i class="bi bi-dice-2-fill"></i>',
                    '<i class="bi bi-dice-3-fill"></i>',
                    '<i class="bi bi-dice-4-fill"></i>',
                    '<i class="bi bi-dice-5-fill"></i>',
                    '<i class="bi bi-dice-6-fill"></i>',
                ];

                var diceAnimation = setInterval(() => {
                    this.dice = _.sample(diceArr);
                    this.today.firstSpeak = _.sample(alivePlayers);
                    this.today.speakingDirection = _.sample(['left', 'right']);
                }, 50);

                setTimeout(() => {
                    clearInterval(diceAnimation);
                    this.disableNext = false;
                    this.dicing = false;
                    this.next();
                }, 1000);
            },
            seerVerify: function() {
                try {
                    if (this.selected.length != 1) {
                        throw '數量不對';
                    }

                    this.tonight.verifyTarget = this.selected[0];
                    var target = this.selected[0];

                    var identity = _.get(this, ['players', target, 'identity'], false)
                    var camp = _.get(roleCard, [identity, 'camp'], false);

                    if (identity != '') {
                        this.tonight.verifyResult = camp
                    } else if (identity == false) {
                        this.tonight.verifyResult = 'good';
                    } else {
                        throw '驗證發生錯誤';
                    }
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            setCity: function() {
                _.forEach(this.players, (value, key) => {
                    if (this.players[key].identity == '') {
                        this.players[key].identity = 'villagers';
                    }
                });
            },
            setIsAlive: function(playerIndex, boolean) {
                this.players[playerIndex].isAlive = boolean;
                this.selected = [];
                this.judgingTheOutcome();
            },
            judgingTheOutcome: function() {
                var count = {
                    'wolves': 0,
                    'priesthood': 0,
                    'villagers': 0,
                }

                _.forEach(this.players, (player, key) => {
                    if (player.isAlive) {
                        count[_.get(roleCard, [player.identity, 'position'], false)] += 1;
                    }
                });

                if (count.wolves == 0) {
                    this.gameOverTitle = '遊戲結束 好人獲勝';
                    this.showModal = 'gameOver';
                    this.disableNext = true;
                    return;
                }

                if (this.victoryCon == VICTORY_CON.KILL_SIDE &&
                    (count.priesthood == 0 || count.villagers == 0)) {
                    this.gameOverTitle = '遊戲結束 狼人獲勝';
                    this.showModal = 'gameOver';
                    this.disableNext = true;
                    return;
                }

                if (this.victoryCon == VICTORY_CON.KILL_ALL &&
                    (count.priesthood == 0 && count.villagers == 0)) {
                    this.gameOverTitle = '遊戲結束 狼人獲勝';
                    this.showModal = 'gameOver';
                    this.disableNext = true;
                    return;
                }
            },
            startTimer: function() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
                this.timer = 60;
                this.timerInterval = setInterval(() => {
                    this.timer -= 1;
                    if (this.timer <= 0) {
                        this.timer = 0;
                        clearInterval(this.timerInterval);
                        return;
                    }
                }, 1000);
            },
            stopTimer: function() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
            },
            resetNightData: function() {
                this.tonight = {
                    killTag: {},
                    killbyHunter: '',
                    killbyWerewolvesKing: '',
                    killedByWerewolves: '',
                    killedByWitch: '',
                    haveUsedAntidote: false,
                    verifyTarget: '',
                    verifyResult: '',
                };
            },
            resetDayData: function() {
                this.today = {
                    killbyHunter: '',
                    killbyWerewolvesKing: '',
                    firstSpeak: '',
                    speakIndex: 0,
                    speakingDirection: '', // left: 順時鐘, right: 逆時鐘
                    killedByVote: '',
                    PKRoundNum: 0,
                };
            },
            runDown: function() {
                var _this = this;
                var arr = [{
                        'messageHtml': '準備進入第' + _this.day + '夜',
                        'tipsHtml': '',
                        'action': function() {},
                    }, {
                        'messageHtml': '天黑請閉眼',
                        'tipsHtml': '',
                        'action': function() {
                            _this.stage = 'night';
                            _this.timeStatus = 'night';
                            _this.selectAutoNext = true;
                        }
                    }, {
                        'messageHtml': '狼人請睜眼<br>請確認彼此身份',
                        'tipsHtml': '（請點選狼王玩家）',
                        'action': function() {
                            // 沒有設定狼王
                            if (_this.roleNum.werewolvesKing <= 0) {
                                return 'pass';
                            }
                            // 僅第一天需要
                            if (_this.day > 1) {
                                return 'pass';
                            }

                            var quota = _.get(_this, ['roleNum', 'werewolvesKing'], 0);
                            if (quota <= 0) {
                                throw 'Set werewolvesKing error: quota <= 0';
                            }

                            _this.setSelectQuota(quota);
                            _this.disableBtn = false;
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            // 僅第一天需要
                            if (_this.day > 1) {
                                return 'pass';
                            }
                            if (_this.roleNum.werewolvesKing > 0) {
                                _this.setIdentity('werewolvesKing');
                                this.messageHtml = '狼人請睜眼<br>請確認彼此身份'
                                this.tipsHtml = '（請點選其他' + _this.roleNum.werewolves + '名狼人玩家）';
                            } else {
                                this.messageHtml = '狼人請睜眼'
                                this.tipsHtml = '（請點選' + _this.roleNum.werewolves + '名狼人玩家）';
                            }

                            var quota = _.get(_this, ['roleNum', 'werewolves'], 0);
                            if (quota <= 0) {
                                throw 'Set werewolves error: quota <= 0';
                            }
                            _this.setSelectQuota(quota);
                            _this.disableBtn = false;
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '（請點選被殺害玩家）',
                        'action': function() {
                            if (_this.day <= 1) {
                                this.messageHtml = '狼人請殺人';
                                _this.setIdentity('werewolves');
                            } else {
                                this.messageHtml = '狼人請睜眼<br>狼人請殺人';
                            }
                            _this.disableBtn = false;
                            _this.setSelectQuota(1);
                            _this.selectAutoNext = false;
                        },
                    }, {
                        'messageHtml': '狼人請閉眼',
                        'tipsHtml': '',
                        'action': function() {
                            _this.setKillTag('wolfKill');
                            _this.disableBtn = true;
                        },
                    }, {
                        'messageHtml': '女巫請睜眼',
                        'tipsHtml': '',
                        'action': function() {
                            // 沒有設定女巫
                            if (_this.roleNum.witch <= 0) {
                                return 'pass';
                            }

                            // 僅第一天需要
                            if (_this.day <= 1) {
                                var quota = _.get(_this, ['roleNum', 'witch'], 0);
                                if (quota <= 0) {
                                    throw 'Set witch error: quota <= 0';
                                }
                                this.tipsHtml = '（請點選女巫玩家）';
                                _this.setSelectQuota(quota);
                                _this.disableBtn = false;
                                _this.selectAutoNext = true;
                            }
                        },
                    }, {
                        'messageHtml': '他死了<br>請問你要使用解藥嗎？',
                        'tipsHtml': '',
                        'modal': '',
                        'action': function() {
                            // 沒有設定女巫
                            if (_this.roleNum.witch <= 0) {
                                return 'pass';
                            }

                            if (_this.day <= 1) {
                                _this.setIdentity('witch');
                            }

                            // 已使用解藥
                            if (_this.isUsedAntidote) {
                                return 'pass';
                            }

                            var theDead = _.findKey(_this.tonight.killTag, (o) => {
                                return o != '';
                            });

                            var witchPlayerKey = _.findKey(_this.players, (player) => {
                                return player == _this.witchPlayer;
                            });

                            this.tipsHtml = '（請用手勢告知 ' + theDead + '號 死亡）';

                            if (theDead == witchPlayerKey) {
                                if (_this.witchRule == WITCH_SELF_HELP_CON.ONLY_FIRST && _this.day > 1) {
                                    this.tipsHtml += '<br><span style="font-size: 0.9rem;">第一夜後不可自救</span>'
                                    return;
                                } else if (_this.witchRule == WITCH_SELF_HELP_CON.CAN_NOT) {
                                    this.tipsHtml += '<br><span style="font-size: 0.9rem;">不可自救</span>'
                                    return;
                                }
                            }

                            if (_.get(_this, ['witchPlayer', 'isAlive'], false) == true) {
                                this.modal = 'usedAntidote';
                            } else {
                                this.tipsHtml = '（念完即可）<br><span style="font-size: 0.9rem;">女巫已出局</span>';
                                _this.disableNext = false;
                                return;
                            }

                            _this.disableBtn = true;
                            _this.disableNext = true;
                        }
                    }, {
                        'messageHtml': '請問你要使用毒藥嗎？<br>你要毒誰呢？',
                        'tipsHtml': '',
                        'modal': '',
                        'action': function() {
                            _this.selectAutoNext = false;
                            // 沒有設定女巫
                            if (_this.roleNum.witch <= 0) {
                                return 'pass';
                            }

                            if (_this.tonight.haveUsedAntidote) {
                                _this.isUsedAntidote = true;
                                _this.tonight.killTag = {};
                            }

                            if (_.get(_this, ['witchPlayer', 'isAlive'], false) == false) {
                                this.tipsHtml = '（念完即可）<br><span style="font-size: 0.9rem;">女巫已出局</span>';
                                _this.disableNext = false;
                                return;
                            }

                            if (_this.tonight.haveUsedAntidote) {
                                this.tipsHtml = '（念完即可）<br><span style="font-size: 0.9rem;">無法同一夜使用解藥毒藥</span>';
                                _this.disableNext = false;
                                return;
                            }
                            if (_this.isUsedPoison) {
                                this.tipsHtml = '（念完即可）<br><span style="font-size: 0.9rem;">已無毒藥</span>';
                                _this.disableNext = false;
                                return;
                            }
                            this.modal = 'usedPoison';
                            this.tipsHtml = '';
                            _this.disableBtn = false;
                            _this.disableNext = true;
                            // (女巫已淘汰，念完即可)
                        }
                    }, {
                        'messageHtml': '女巫請閉眼',
                        'tipsHtml': '',
                        'modal': '',
                        'action': function() {
                            // 沒有設定女巫
                            if (_this.roleNum.witch <= 0) {
                                return 'pass';
                            }
                            _this.setKillTag('witchKill', true);
                            _this.disableBtn = true;
                            _this.disableNext = false;
                        }
                    }, {
                        'messageHtml': '預言家請睜眼',
                        'tipsHtml': '',
                        'action': function() {
                            // 沒有設定預言家
                            if (_this.roleNum.seer <= 0) {
                                return 'pass';
                            }
                            // 僅第一天需要
                            if (_this.day <= 1) {
                                var quota = _.get(_this, ['roleNum', 'seer'], 0);
                                if (quota <= 0) {
                                    throw 'Set seer error: quota <= 0';
                                }
                                this.tipsHtml = '（請點選預言家玩家）';
                                _this.setSelectQuota(quota);
                                _this.disableBtn = false;
                                _this.selectAutoNext = true;
                            }
                        },
                    }, {
                        'messageHtml': '請選擇你要查驗的對象',
                        'tipsHtml': '（請點選被查驗對象）',
                        'action': function() {
                            // 沒有設定預言家
                            if (_this.roleNum.seer <= 0) {
                                return 'pass';
                            }
                            if (_this.day <= 1) {
                                _this.setIdentity('seer');
                            }
                            if (_.get(_this, ['seerPlayer', 'isAlive'], false) != true) {
                                this.tipsHtml = '（念完即可）<br><span style="font-size: 0.9rem;">預言家已淘汰</span>';
                                return;
                            }

                            _this.disableBtn = false;
                            _this.selectAutoNext = false;
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '（請用手勢告知身份）',
                        'action': function() {
                            // 沒有設定預言家
                            if (_this.roleNum.seer <= 0) {
                                return 'pass';
                            }
                            if (_.get(_this, ['seerPlayer', 'isAlive'], false) != true) {
                                return 'pass';
                            }
                            _this.seerVerify();
                            this.messageHtml = _this.tonight.verifyResult === 'good' ?
                                '<i class="bi bi-hand-thumbs-up-fill"></i>' : '<i class="bi bi-hand-thumbs-down-fill"></i>';
                            _this.disableBtn = true;
                            logArr.push('預言家驗證' + _this.selected[0] + '號' + logLang[_this.tonight.verifyResult]);
                            _this.selected = [];
                        }
                    }, {
                        'messageHtml': '預言家請閉眼',
                        'tipsHtml': '',
                        'action': function() {
                            // 沒有設定預言家
                            if (_this.roleNum.seer <= 0) {
                                return 'pass';
                            }
                        }
                    }, {
                        'messageHtml': '獵人請睜眼',
                        'tipsHtml': '（請點選獵人玩家）',
                        'action': function() {
                            // 沒有設定獵人
                            if (_this.roleNum.hunter <= 0) {
                                return 'pass';
                            }
                            if (_this.day > 1) {
                                return 'pass';
                            }

                            // 僅第一天需要
                            var quota = _.get(_this, ['roleNum', 'hunter'], 0);
                            if (quota <= 0) {
                                throw 'Set hunter error: quota <= 0';
                            }
                            _this.setSelectQuota(quota);
                            _this.disableBtn = false;
                            _this.selectAutoNext = true;
                        },
                    }, {
                        'messageHtml': '獵人請閉眼',
                        'tipsHtml': '',
                        'action': function() {
                            // 沒有設定獵人
                            if (_this.roleNum.hunter <= 0) {
                                return 'pass';
                            }
                            if (_this.day > 1) {
                                return 'pass';
                            }
                            _this.setIdentity('hunter');
                            _this.disableBtn = true;
                        },
                    }, {
                        'messageHtml': '騎士請睜眼',
                        'tipsHtml': '（請點選騎士玩家）',
                        'action': function() {
                            // 沒有設定騎士
                            if (_this.roleNum.knight <= 0) {
                                return 'pass';
                            }
                            if (_this.day > 1) {
                                return 'pass';
                            }
                            // 僅第一天需要
                            var quota = _.get(_this, ['roleNum', 'knight'], 0);
                            if (quota <= 0) {
                                throw 'Set hunter error: quota <= 0';
                            }
                            _this.setSelectQuota(quota);
                            _this.disableBtn = false;
                        },
                    }, {
                        'messageHtml': '騎士請閉眼',
                        'tipsHtml': '',
                        'action': function() {
                            // 沒有設定騎士
                            if (_this.roleNum.knight <= 0) {
                                return 'pass';
                            }
                            if (_this.day > 1) {
                                return 'pass';
                            }
                            _this.setIdentity('knight');
                            _this.disableBtn = true;
                        },
                    }, {
                        'messageHtml': '天亮了',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.day <= 1) {
                                _this.setCity();
                            }
                            _this.selectAutoNext = false;
                            _this.timeStatus = 'day';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            _this.executeKillTag();
                            _this.setDefaultFirstSpeaker();
                            _this.tonight.killTag = {};
                            if (_this.tonight.haveUsedAntidote) {
                                this.messageHtml = '昨晚是平安夜';
                            } else {
                                this.messageHtml = '昨晚 ' + _.filter([
                                    _this.tonight.killedByWerewolves,
                                    _this.tonight.killedByWitch,
                                ], function(killed) {
                                    return killed !== '';
                                }).sort(function(a, b) {
                                    return a - b;
                                }).join('號、') + '號 玩家出局';
                            }

                        },
                    },
                    //夜晚 狼刀到獵人
                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            var theDead = _.get(_this, ['tonight', 'killedByWerewolves'], '');
                            if (theDead == '' || _.get(_this, ['players', theDead, 'identity']) !== 'hunter') {
                                return 'pass';
                            }
                            this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                            this.tipsHtml = '（請點選技能使用對象）';
                            _this.disableBtn = false;
                            _this.stage = 'usingSkill';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.passSkillFlag) {
                                _this.stage = 'day';
                                this.messageHtml = _.get(_this, ['tonight', 'killedByWerewolves'], '') + '號玩家不使用技能';
                                _this.passSkillFlag = false;
                                return;
                            }
                            var theDead = _.get(_this, ['tonight', 'killedByWerewolves'], '');
                            if (theDead == '' || _.get(_this, ['players', theDead, 'identity']) !== 'hunter') {
                                return 'pass';
                            }
                            this.messageHtml = _this.selected[0] + '號玩家出局';
                            _this.hunterKill('night');
                            _this.stage = 'day';
                        },
                    },
                    // 獵槍殺到狼王case
                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            var theDead = _this.tonight.killbyHunter;
                            if (theDead == '' || _this.players[theDead].identity !== 'werewolvesKing') {
                                return 'pass'
                            }
                            this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                            this.tipsHtml = '（請點選技能使用對象）';
                            _this.disableBtn = false;
                            _this.stage = 'usingSkill';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.passSkillFlag) {
                                _this.stage = 'day';
                                this.messageHtml = _this.tonight.killbyHunter + '號玩家不使用技能';
                                _this.passSkillFlag = false;
                                return;
                            }
                            var theDead = _this.tonight.killbyHunter;
                            if (theDead == '' || _this.players[theDead].identity !== 'werewolvesKing') {
                                return 'pass'
                            }
                            this.messageHtml = _this.selected[0] + '號玩家出局';
                            _this.werewolvesKingKill('day');
                            _this.stage = 'day';
                        },
                    },
                    // 夜晚 狼王自刀
                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            var theDead = _.get(_this, ['tonight', 'killedByWerewolves'], '');
                            if (theDead == '' || _.get(_this, ['players', theDead, 'identity']) !== 'werewolvesKing') {
                                return 'pass';
                            }
                            this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                            this.tipsHtml = '（請點選技能使用對象）';
                            _this.disableBtn = false;
                            _this.stage = 'usingSkill';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.passSkillFlag) {
                                _this.stage = 'day';
                                this.messageHtml = _.get(_this, ['tonight', 'killedByWerewolves'], '') + '號玩家不使用技能';
                                _this.passSkillFlag = false;
                                return;
                            }
                            var theDead = _.get(_this, ['tonight', 'killedByWerewolves'], '');
                            if (theDead == '' || _.get(_this, ['players', theDead, 'identity']) !== 'werewolvesKing') {
                                return 'pass';
                            }
                            this.messageHtml = _this.selected[0] + '號玩家出局';
                            _this.werewolvesKingKill('night');
                            _this.stage = 'day';
                        },
                    },
                    // 狼王殺到獵人 case
                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            var theDead = _this.tonight.killbyWerewolvesKing;
                            if (theDead == '' || _this.players[theDead].identity !== 'hunter') {
                                return 'pass'
                            }
                            this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                            this.tipsHtml = '（請點選技能使用對象）';
                            _this.disableBtn = false;
                            _this.stage = 'usingSkill';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.passSkillFlag) {
                                _this.stage = 'day';
                                this.messageHtml = _this.tonight.killbyWerewolvesKing + '號玩家不使用技能';
                                _this.passSkillFlag = false;
                                return;
                            }
                            var theDead = _this.tonight.killbyWerewolvesKing;
                            if (theDead == '' || _this.players[theDead].identity !== 'hunter') {
                                return 'pass'
                            }
                            this.messageHtml = _this.selected[0] + '號玩家出局';
                            _this.hunterKill('day');
                            _this.stage = 'day';
                        },
                    }, {
                        'messageHtml': '請發表遺言',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.day > 1 || _this.tonight.haveUsedAntidote) {
                                return 'pass';
                            }
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '（決定發言順序）',
                        'modal': 'speakingModal',
                        'action': function() {
                            _this.disableBtn = true;
                            _this.disableNext = true;
                            _this.selected = [];
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            _this.stage = 'speaking';
                            _this.showModal = false;
                            _this.disableNext = false;
                            var totalPlayers = _.size(_this.players);
                            var direction = _this.today.speakingDirection == 'left' ? '順時針' : '逆時針';
                            var next = (_this.today.speakingDirection == 'left' ? (_this.today.firstSpeak + 1) : (_this.today.firstSpeak - 1));
                            this.messageHtml = '由' + _this.today.firstSpeak + '號玩家開始發言<br>往' + direction + '方向接續';
                        },
                    }, {
                        'messageHtml': '現在準備投票',
                        'tipsHtml': '',
                        'action': function() {
                            _this.showTimer = false;
                        },
                    }, {
                        'messageHtml': '3、2、1 請投票',
                        'tipsHtml': '（請點選遭投票出局玩家）',
                        'action': function() {
                            _this.disableBtn = false;
                            _this.stage = 'voting';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.clickPKFlag) {
                                _this.today.PKRoundNum += 1;
                                _this.clickPKFlag = false;
                            }
                            if (_this.today.PKRoundNum == 1) {
                                this.messageHtml = '進行辯論<br>請平票候選人依序發言';
                                _this.disableBtn = false;
                                logArr.push('平票辯論');
                                _this.stage = 'PKSpeaking';
                                return;
                            }
                            this.messageHtml = _this.selected[0] + '號玩家出局';
                            _this.voteKill();
                            _this.stage = 'day';
                        },
                    },
                    // 平票PK
                    {
                        'messageHtml': '再次準備投票',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.today.PKRoundNum == 1) {
                                return;
                            }
                            return 'pass';
                        },
                    }, {
                        'messageHtml': '3、2、1 請投票',
                        'tipsHtml': '（請點選遭投票出局玩家）',
                        'action': function() {
                            if (_this.today.PKRoundNum == 1) {
                                _this.disableBtn = false;
                                _this.stage = 'voting';
                                return;
                            }
                            return 'pass';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.clickPKFlag) {
                                _this.today.PKRoundNum += 1;
                                _this.clickPKFlag = false;
                            }
                            if (_this.today.PKRoundNum == 1) {
                                this.messageHtml = _this.selected[0] + '號玩家出局';
                                _this.voteKill();
                                _this.stage = 'day';
                            } else {
                                return 'pass';
                            }
                        },
                    },
                    //票到獵人或狼王 strat
                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            var theDead = _.get(_this, ['today', 'killedByVote'], '');
                            var theDeadIdentity = _.get(_this, ['players', theDead, 'identity'], '');

                            if (theDeadIdentity === 'hunter' ||
                                theDeadIdentity === 'werewolvesKing') {
                                this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                                this.tipsHtml = '（請點選技能使用對象）';
                                _this.disableBtn = false;
                                _this.stage = 'usingSkill';
                                return;
                            }
                            return 'pass';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.passSkillFlag) {
                                _this.stage = 'day';
                                this.messageHtml = _.get(_this, ['today', 'killedByVote'], '') + '號玩家不使用技能';
                                _this.passSkillFlag = false;
                                return;
                            }
                            var theDead = _.get(_this, ['today', 'killedByVote'], '');
                            var theDeadIdentity = _.get(_this, ['players', theDead, 'identity'], '');

                            this.messageHtml = _this.selected[0] + '號玩家出局';
                            if (theDeadIdentity === 'hunter') {
                                _this.hunterKill('day');
                                _this.stage = 'day';
                                return;
                            } else if (theDeadIdentity === 'werewolvesKing') {
                                _this.werewolvesKingKill('day');
                                _this.stage = 'day';
                                return;
                            }
                            return 'pass';
                        },
                    }, {
                        //又殺到狼王或獵人＊＊＊＊＊＊＊＊＊＊＊＊＊
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.today.killbyHunter != '') {
                                var theDead = _this.today.killbyHunter;
                                if (_.get(_this, ['players', theDead, 'identity'], '') === 'werewolvesKing') {
                                    this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                                    this.tipsHtml = '（請點選技能使用對象）';
                                    _this.disableBtn = false;
                                    _this.stage = 'usingSkill';
                                    return;
                                }
                            }
                            if (_this.today.killbyWerewolvesKing != '') {
                                var theDead = _this.today.killbyWerewolvesKing;
                                if (_.get(_this, ['players', theDead, 'identity'], '') === 'hunter') {
                                    this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                                    this.tipsHtml = '（請點選技能使用對象）';
                                    _this.disableBtn = false;
                                    _this.stage = 'usingSkill';
                                    return;
                                }
                            }
                            return 'pass';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.today.killbyHunter != '') {
                                var theDead = _this.today.killbyHunter;
                                if (_.get(_this, ['players', theDead, 'identity'], '') === 'werewolvesKing') {
                                    if (_this.passSkillFlag) {
                                        _this.stage = 'day';
                                        this.messageHtml = theDead + '號玩家不使用技能';
                                        _this.passSkillFlag = false;
                                        return;
                                    }

                                    this.messageHtml = _this.selected[0] + '號玩家出局';
                                    _this.werewolvesKingKill('day');
                                    _this.stage = 'day';
                                    return;
                                }
                            }
                            if (_this.today.killbyWerewolvesKing != '') {
                                var theDead = _this.today.killbyWerewolvesKing;
                                if (_.get(_this, ['players', theDead, 'identity'], '') === 'hunter') {
                                    if (_this.passSkillFlag) {
                                        _this.stage = 'day';
                                        this.messageHtml = theDead + '號玩家不使用技能';
                                        _this.passSkillFlag = false;
                                        return;
                                    }

                                    this.messageHtml = _this.selected[0] + '號玩家出局';
                                    _this.hunterKill('day');
                                    _this.stage = 'day';
                                    return;
                                }
                            }
                            return 'pass';
                        },
                    },
                    //票到獵人或狼王 end
                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.today.killedByVote == '' && _this.today.PKRoundNum == 2) {
                                this.messageHtml = '再次平票，進入黑夜'
                            } else {
                                this.messageHtml = '請發表遺言'
                            }
                            _this.stage = 'day';
                            _this.disableBtn = true;
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            _this.actionNum = 0;
                            _this.day += 1;
                            _this.resetNightData();
                            _this.resetDayData();
                            return 'pass';
                        },
                    },

                    //狼王自爆專用

                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            this.messageHtml = _this.selected[0] + '號玩家出局<br>沒有遺言';
                            _this.werewolvesKingKill('day');
                            _this.stage = 'day';
                        },
                    },
                    //爆到獵人
                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            var theDead = _this.today.killbyWerewolvesKing;
                            if (theDead == '' || _this.players[theDead].identity !== 'hunter') {
                                return 'pass'
                            }
                            this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                            this.tipsHtml = '（請點選技能使用對象）';
                            _this.disableBtn = false;
                            _this.stage = 'usingSkill';
                            logArr.push(this.messageHtml);
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.passSkillFlag) {
                                _this.stage = 'day';
                                this.messageHtml = _this.today.killbyWerewolvesKing + '號玩家不使用技能';
                                _this.passSkillFlag = false;
                                return;
                            }
                            var theDead = _this.today.killbyWerewolvesKing;
                            if (theDead == '' || _this.players[theDead].identity !== 'hunter') {
                                return 'pass'
                            }
                            this.messageHtml = _this.selected[0] + '號玩家出局<br>沒有遺言';
                            _this.hunterKill('day');
                            _this.stage = 'day';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            _this.actionNum = 0;
                            _this.day += 1;
                            _this.resetNightData();
                            _this.resetDayData();
                            return 'pass';
                        },
                    },
                ];

                return arr[this.actionNum];
            },

        },
        computed: {
            knightBattleDisable: function() {
                // 有bug
                return this.knightIsUsedSkill;
            },
            seerPlayer: function() {
                return this.players[this.rolePlayerIndex.seer];
            },
            //bug 沒拿到的時候會用1號去擋
            knightPlayer: function() {
                return this.players[this.rolePlayerIndex.knight];
            },
            witchPlayer: function() {
                return this.players[this.rolePlayerIndex.witch];
            },
            functionBarBtns: function() {
                var _this = this;
                return [{
                        class: 'function-btn',
                        click: () => {
                            _this.showModal = 'knightBattle';
                        },
                        disable: _this.knightBattleDisable,
                        html: '騎士查驗',
                        isShow: !(_this.stage == 'voting' || _this.stage == 'usingSkill')
                    },

                    {
                        class: 'function-btn',
                        click: () => {
                            _this.showModal = 'wolfKillSelf';
                        },
                        disable: false,
                        html: '狼人自爆',
                        isShow: !(_this.stage == 'voting' || _this.stage == 'usingSkill')
                    }, {
                        class: 'function-btn special',
                        click: _this.pkRound,
                        disable: false,
                        html: _this.today.PKRoundNum == 0 ? '票數相同 進行辯論' : '票數再次相同 進入黑夜',
                        isShow: _this.stage == 'voting',
                    }, {
                        class: 'function-btn special',
                        click: () => {
                            _this.passSkillFlag = true;
                            _this.next();
                        },
                        disable: false,
                        html: '不使用技能',
                        isShow: _this.stage == 'usingSkill'
                    }
                ];
            },
        }
    })
</script>