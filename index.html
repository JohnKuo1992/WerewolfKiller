<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="custom.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <!-- template for the modal component -->
    <script type="text/x-template" id="modal-template">
        <transition name="modal">
            <div class="modal-mask">
                <div class="modal-wrapper">
                    <div class="modal-container">
                        <div class="modal-header-custom text-center p-1">
                            <slot name="header">
                                <!-- default header -->
                            </slot>
                        </div>
                        <div class="modal-body-custom p-1">
                            <slot name="body">
                                <!-- default body -->
                            </slot>
                        </div>
                        <div class="modal-footer-custom">
                            <slot name="footer">
                                <!-- default footer -->
                            </slot>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
    </script>
    <title>歡迎使用狼人殺筆記助理</title>
</head>

<body>
    <div id="app" style="background-color: rgb(47 47 47);" :class="timeStatus">
        <div class="header-bar text-center lock-mobile-width bg-color-2">
            <div class="container-sm">
                <transition name="slide-fade" mode="out-in">
                    <div v-if="hostMessage" :key="hostMessage" class="host-message text-center">
                        <div class="host-text-arrow"></div>
                        <div v-html="hostMessage"></div>
                    </div>
                </transition>
                <div class="judge-icon">
                    <i class="bi bi-person-fill"></i>
                </div>
                <div v-if="hostTips" :key="hostTips" class="host-tips text-center" v-html="hostTips">
                </div>
            </div>
        </div>
        <div class="function-bar lock-mobile-width bg-color-2">
            <div class="function-bar-wapper">
                <button v-for="btn in functionBarBtns" class="btn-color-green" v-show="btn.isShow" :class="btn.class" @click="btn.click" :disabled="btn.disable" v-html="btn.html"></button>
                <div style="width: 25px;"></div>
            </div>
            <div id="maskNavBar" class="function-bar-mask"></div>
        </div>

        <div class="container-sm lock-mobile-width bg-color-1" style="min-height: 100%;">
            <div class="row">
                <!-- for Complement header height -->
                <div style="height: 220px;"></div>

                <div class="container">
                    <div class="row g-3">
                        <div v-for="(player, index) in players" class="player-btn-contanier text-center text-clould col-4" :class="isSelected(index) ? 'selected-btn': ''" v-on:click="btnClick(index)">
                            <div class="player-btn p-2" :class="isSelected(index) ? 'selected': ''">
                                <div>
                                    <span class="number">P{{ index }}</span><br>
                                    <span>{{ player.name }}</span><br>
                                    <input :id="index" :ref="index" type="checkbox" :name="index" v-model="selected" :value="index" :disabled="disableBtn" style="display: none;">
                                </div>
                            </div>
                            <div v-if="!player.isAlive" class="death-tag p-2">
                                <div></div>
                            </div>
                            <div v-if="_.get(tonight, ['killTag', index], false)" class="kill-tag p-2">
                                <div></div>
                            </div>
                            <div v-if="player.identity != ''" class="role-tag p-2">
                                <div>
                                    <i class="bi bi-flag-fill" :class="_.get(roleCard, [player.identity, 'position'], '') + '-color'"></i>&nbsp{{ _.get(roleCard, [player.identity, 'text'], '')}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- for Complement bottom bar height -->
                <div style="height: 70px;"></div>
                <br>
            </div>
        </div>
        <div class="bottom-bar lock-mobile-width bg-color-2">
            <button class="next-btn btn-color-green" v-on:click="back()"><i class="bi bi-arrow-counterclockwise"></i>還原</button>
            <button class="next-btn btn-color-green" v-on:click="next()" :disabled="disableNext && selected.length == 0">下一步 <i class="bi bi-arrow-right-circle-fill"></i></button>
        </div>
        <!-- 使用解藥 -->
        <modal v-show="showModal == 'usedAntidote'" @close="showModal = false">
            <div slot="header">
                使用<span style="color: #1dd1a1;">解藥？</span>
            </div>
            <div slot="footer">
                <button class="modal-btn" v-on:click="witchSave(true)">是</button>
                <button class="modal-btn" v-on:click="witchSave(false)">否</button>
            </div>
        </modal>
        <!-- 使用毒藥 -->
        <modal v-show="showModal == 'usedPoison'" @close="showModal = false">
            <div slot="header">
                使用<span style="color: #9b59b6;">毒藥？</span>
            </div>
            <div slot="footer">
                <button class="modal-btn" v-on:click="showModal = false">是</button>
                <button class="modal-btn" v-on:click="showModal = false, next()">否</button>
            </div>
        </modal>
        <!-- 騎士對決 -->
        <modal v-show="showModal == 'knightBattle'" @close="showModal = false">
            <div v-show="stage != 'speaking'" slot="header">騎士查驗</div>
            <div v-show="stage == 'speaking'" slot="header">請選擇騎士查驗對象</div>
            <div v-show="stage == 'speaking'" slot="body">
                <div v-for="(player, key) in players" class="col-4" style="display: inline-block;" v-on:click="function() { if(!player.isAlive || key == _.findKey(players, knightPlayer)) {return;} knightChoose = key; }">
                    <div class="modal-player-btn" :class="{'selected': knightChoose == key, 'disable': !player.isAlive || key == _.findKey(players, knightPlayer)}">
                        {{ key }}
                    </div>
                </div>
                <div style="height: 15px;"></div>
                <div style="background: linear-gradient(rgba(255, 255, 255, 0), rgb(255, 255, 255, 0.8), rgb(255, 255, 255, 0.97), rgb(255, 255, 255, 1));
                position: absolute;
                bottom: 80px;
                left: 0px;
                width: 100%;
                height: 30px;"></div>
            </div>
            <div v-show="stage != 'speaking'" slot="body" class="text-center">
                僅能在白天發言階段使用。
            </div>
            <div v-show="stage == 'speaking'" slot="footer" class="text-center">
                <button class="modal-btn" v-on:click="knightBattle(knightChoose)">確定</button>
                <button class="modal-btn" v-on:click="showModal = false">取消</button>
            </div>
            <div v-show="stage != 'speaking'" slot="footer" class="text-center">
                <button class="modal-btn" v-on:click="showModal = false">關閉</button>
            </div>
        </modal>
        <!-- 狼人自爆 -->
        <modal v-if="showModal == 'wolfKillSelf'" @close="showModal = false">
            <div v-show="stage != 'speaking'" slot="header">狼人自爆</div>
            <div v-show="stage == 'speaking'" slot="header">請選擇自爆的狼人</div>
            <div v-show="stage == 'speaking'" slot="body">
                <div v-for="(player, key) in players" class="col-4" v-if="player.isAlive && _.get(roleCard, [player.identity, 'camp'], '') === 'bad'" style="display: inline-block;" v-on:click="wolfKillSelfChoose = key">
                    <div class="modal-player-btn" :class="{'selected': wolfKillSelfChoose == key}">
                        {{ key }}
                    </div>
                </div>
                <br>
            </div>
            <div v-show="stage != 'speaking'" slot="body" class="text-center">
                僅能在白天發言階段使用。
            </div>
            <div v-show="stage == 'speaking'" slot="footer" class="text-center">
                <button class="modal-btn" v-on:click="wolfKillSelf(wolfKillSelfChoose)">確定</button>
                <button class="modal-btn" v-on:click="showModal = false">取消</button>
            </div>
            <div v-show="stage != 'speaking'" slot="footer" class="text-center">
                <button class="modal-btn" v-on:click="showModal = false">關閉</button>
            </div>
        </modal>
        <!-- 觀看log -->
        <modal v-show="showModal == 'logPage'" @close="showModal = false">
            <h3 slot="header">紀錄</h3>
            <div class="mx-2 my-4" slot="body" style="display: flex;">

                <br>
                <button class="modal-btn" v-on:click="showModal = false">關閉</button>
            </div>
            <div slot="footer"></div>
        </modal>

        <!-- 遊戲結束 -->
        <modal v-if="showModal == 'gameOver'" @close="showModal = false">
            <div slot="header">{{gameOverTitle}}</div>
            <div slot="body">
                喜歡這個程式嗎？<br> 是否願意贊助我們喝杯咖啡 $70
            </div>
            <div slot="footer">
                <button class="modal-btn" v-on:click="showModal = false">確定</button>
                <button class="modal-btn" v-on:click="showModal = false">取消</button>
            </div>
        </modal>
    </div>
</body>

</html>

<script>
    const VICTORY_CON = {
        'KILL_SIDE': 'killSide',
        'KILL_ALL': 'killAll',
    }

    const WITCH_SELF_HELP_CON = {
        'ONLY_FIRST': 'onlyFirst',
        'CAN_NOT': 'canNot',
    }

    var roleNum = {
        'werewolvesKing': 1,
        'werewolves': 3,
        'seer': 1,
        'witch': 1,
        'hunter': 1,
        'knight': 1,
        'villagers': 4,
    }
    var roleCard = {
        'werewolvesKing': {
            'id': 'werewolvesKing',
            'text': '狼王',
            'camp': 'bad',
            'position': 'wolves',
        },
        'werewolves': {
            'id': 'werewolves',
            'text': '狼人',
            'camp': 'bad',
            'position': 'wolves',
        },
        'seer': {
            'id': 'seer',
            'text': '預言家',
            'camp': 'good',
            'position': 'priesthood',
        },
        'witch': {
            'id': 'witch',
            'text': '女巫',
            'camp': 'good',
            'position': 'priesthood',
        },
        'hunter': {
            'id': 'hunter',
            'text': '獵人',
            'camp': 'good',
            'position': 'priesthood',
        },
        'knight': {
            'id': 'knight',
            'text': '騎士',
            'camp': 'good',
            'position': 'priesthood',
        },
        'villagers': {
            'id': 'villagers',
            'text': '村民',
            'camp': 'good',
            'position': 'villagers',
        }
    };

    var temp = [];


    }

    Vue.component("modal", {
        template: "#modal-template"
    });

    var app = new Vue({
        el: '#app',
        data: {
            roleCard: roleCard,
            isSpeakingStage: false,
            stage: '',
            timeStatus: 'day',
            day: 1,
            hostMessage: '',
            hostTips: '',
            actionNum: 0,
            selected: [],
            selectQuota: 0,
            selectAutoNext: false,
            disableBtn: true,
            disableNext: false,

            tonight: {
                killTag: {},
                killbyHunter: '',
                killbyWerewolvesKing: '',
                killedByWerewolves: '',
                killedByWitch: '',
                haveUsedAntidote: false,
                verifyTarget: '',
                verifyResult: '',
            },
            today: {
                killbyHunter: '',
                killbyWerewolvesKing: '',
                firstSpeak: '',
                speakIndex: 0,
                speakingDirection: '', // left: 順時鐘, right: 逆時鐘
                killedByVote: '',
                PKRoundNum: 0,
            },
            clickPKFlag: false,
            passSkillFlag: false,
            isUsedAntidote: false,
            isUsedPoison: false,
            tonightWitchSave: null,
            witchSelfHelpCon: WITCH_SELF_HELP_CON.ONLY_FIRST,

            tonightVerify: null,

            knightChoose: '',
            knightIsUsedSkill: false,

            showTimer: false,
            timer: 0,
            timerInterval: null,

            showModal: '',
            gameOverTitle: '',

            playerNum: 0,
            players: {},
            roleNum: {
                'werewolvesKing': 0,
                'werewolves': 0,
                'seer': 0,
                'witch': 0,
                'hunter': 0,
                'knight': 0,
                'villagers': 0,
            },
            victoryCon: VICTORY_CON.KILL_SIDE,
        },
        watch: {
            'selected': function(val, oldVal) {
                if (val.length == 0) {
                    return;
                }
                if (val.length == this.selectQuota) {
                    if (this.selectAutoNext) {
                        this.next();
                    }
                }
            }
        },
        methods: {
            initPlayer: function() {
                for (var i = 1; i <= this.playerNum; i++) {
                    this.players[i] = {
                        'key': i,
                        'name': i + '號玩家',
                        'identity': '',
                        'isAlive': true,
                    }
                }
            },
            next: function() {
                var backupData = _.cloneDeep(this.$data);
                var nowRunDown = this.runDown();

                if (typeof(nowRunDown.action) === 'function') {
                    try {
                        if (nowRunDown.action() === 'pass') {
                            this.actionNum += 1;
                            this.next();
                            return;
                        };
                    } catch (e) {
                        console.log('error at next: ', e);
                        return;
                    }
                }
                this.hostMessage = nowRunDown.messageHtml;
                this.hostTips = nowRunDown.tipsHtml;
                if (_.has(nowRunDown, ['modal'])) {
                    this.showModal = _.get(nowRunDown, ['modal'], false);
                }
                this.actionNum += 1;
                this.backup(backupData);
            },
            backup: function(backupData) {
                if (temp.length > 20) {
                    temp = _.drop(temp);
                }
                temp.push(backupData);
            },
            back: function() {
                if (temp.length <= 1) {
                    return;
                }

                var previousData = _.last(temp);
                temp.pop();
                _.forEach(this.$data, (value, key) => {
                    this.$data[key] = previousData[key]
                });
                this.selected = [];
                this.clickPKFlag = false;
                this.passSkillFlag = false;
            },
            pkRound: function() {
                this.clickPKFlag = true;
                this.next();
            },
            knightBattle: function(target) {
                if (this.knightIsUsedSkill) {
                    return;
                }
                var knightPlayerKey = _.findKey(this.players, this.knightPlayer);
                if (target == '' || target == this.knightPlayer || !this.players[target].isAlive) {
                    return;
                }
                this.showModal = false;
                var backupData = _.cloneDeep(this.$data);

                this.showTimer = false;
                var targetIdentity = _.get(this, ['players', target, 'identity'], '');
                var targetCamp = _.get(roleCard, [targetIdentity, 'camp'], '');
                if (targetCamp == 'bad') {
                    this.hostMessage = target + '號 是狼人！<br>準備進入黑夜'
                    this.setIsAlive(target, false);
                    this.resetNightData();
                    this.resetDayData();
                    this.actionNum = 0;
                    this.day += 1;
                } else if (targetCamp == 'good') {
                    this.hostMessage = target + '號 不是狼人！<br>' + knightPlayerKey + '號 騎士以死謝罪'
                    this.setIsAlive(knightPlayerKey, false);
                }
                this.knightIsUsedSkill = true;
                this.backup(backupData);
            },
            },
            setSelectQuota: function(quota) {
                this.selectQuota = quota;
            },
            setIdentity: function(role) {
                try {
                    if (this.selected.length != this.selectQuota) {
                        throw '數量不對';
                    }

                    _.forEach(this.selected, (key) => {
                        if (this.players[key].identity !== '') {
                            throw '已經設定角色';
                        } else {
                            this.players[key].identity = role;
                        }
                    });

                    this.selected = [];
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            btnClick: function(index) {
                $('#' + index).trigger('click');
            },
            isSelected: function(index) {
                return _.indexOf(this.selected, index) >= 0;
            },
            // kill相關
            setKillTag: function(type = '', canPass = false) {
                try {
                    if (canPass && this.selected.length == 0) {
                        return;
                    }

                    if (this.selected.length != 1) {
                        throw '數量不對';
                    }
                    if (type == '') {
                        throw 'Type不對';
                    }
                    this.tonight.killTag[this.selected[0]] = type;
                    this.selected = [];
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            executeKillTag: function() {
                _.forEach(this.tonight.killTag, (deadType, index) => {
                    if (typeof(this[deadType] === 'function')) {
                        this[deadType](index);
                    }
                });
            },
            wolfKill: function(target) {
                try {
                    this.tonight.killedByWerewolves = target;
                    this.setIsAlive(target, false);
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            witchKill: function(target) {
                try {
                    this.tonight.killedByWitch = target;
                    this.isUsedPoison = true;
                    this.setIsAlive(target, false);
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            voteKill: function() {
                try {
                    if (this.selected.length != 1) {
                        throw '數量不對';
                    }
                    this.today.killedByVote = this.selected[0];
                    this.setIsAlive(this.today.killedByVote, false);
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            hunterKill: function(time = 'night') {
                try {
                    if (this.selected.length != 1) {
                        throw '數量不對';
                    }
                    if (time == 'night') {
                        this.tonight.killbyHunter = this.selected[0];
                    } else if (time == 'day') {
                        this.today.killbyHunter = this.selected[0];
                    }
                    this.setIsAlive(this.selected[0], false);
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            werewolvesKingKill: function(time = 'night') {
                try {
                    if (this.selected.length != 1) {
                        throw '數量不對';
                    }
                    if (time == 'night') {
                        this.tonight.killbyWerewolvesKing = this.selected[0];
                    } else if (time == 'day') {
                        this.today.killbyWerewolvesKing = this.selected[0];
                    }
                    this.setIsAlive(this.selected[0], false);
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            witchSave: function(boolean) {
                this.tonight.haveUsedAntidote = boolean;
                this.next();
            },
            randomOrder: function() {
                var direction = _.sample(['left', 'right']);
                var first = _.sample(_.keys(this.players));
                var totalPlayers = _.size(this.players);

                for (var i = 0; i < totalPlayers; i++) {
                    var index = (first + i) % totalPlayers <= 0 ? (first + i) % totalPlayers + totalPlayers : (first + i) % totalPlayers;
                    if (this.players[index].isAlive == true) {
                        this.today.speakingDirection = direction;
                        this.today.firstSpeak = index;
                        return;
                    }
                }
            },
            seerVerify: function() {
                try {
                    if (this.selected.length != 1) {
                        throw '數量不對';
                    }

                    this.tonight.verifyTarget = this.selected[0];
                    var target = this.selected[0];

                    var identity = _.get(this, ['players', target, 'identity'], false)
                    var camp = _.get(roleCard, [identity, 'camp'], false);

                    console.log(identity);
                    if (identity != '') {
                        this.tonight.verifyResult = camp
                    } else if (identity == false) {
                        this.tonight.verifyResult = 'good';
                    } else {
                        throw '驗證發生錯誤';
                    }
                } catch (e) {
                    console.log(e);
                    throw e;
                }
            },
            setCity: function() {
                _.forEach(this.players, (value, key) => {
                    if (this.players[key].identity == '') {
                        this.players[key].identity = 'villagers';
                    }
                });
            },
            setIsAlive: function(playerIndex, boolean) {
                this.players[playerIndex].isAlive = boolean;
                this.selected = [];
                this.judgingTheOutcome();
            },
            judgingTheOutcome: function() {
                var count = {
                    'wolves': 0,
                    'priesthood': 0,
                    'villagers': 0,
                }

                _.forEach(this.players, (player, key) => {
                    if (player.isAlive) {
                        count[_.get(roleCard, [player.identity, 'position'], false)] += 1;
                    }
                });

                if (count.wolves == 0) {
                    this.gameOverTitle = '遊戲結束 好人獲勝';
                    this.showModal = 'gameOver';
                    this.disableNext = true;
                    return;
                }

                if (this.victoryCon == VICTORY_CON.KILL_SIDE &&
                    (count.priesthood == 0 || count.villagers == 0)) {
                    this.gameOverTitle = '遊戲結束 狼人獲勝';
                    this.showModal = 'gameOver';
                    this.disableNext = true;
                    return;
                }

                if (this.victoryCon == VICTORY_CON.KILL_ALL &&
                    (count.priesthood == 0 && count.villagers == 0)) {
                    this.gameOverTitle = '遊戲結束 狼人獲勝';
                    this.showModal = 'gameOver';
                    this.disableNext = true;
                    return;
                }
            },
            startTimer: function() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
                this.timer = 60;
                this.timerInterval = setInterval(() => {
                    this.timer -= 1;
                    if (this.timer <= 0) {
                        this.timer = 0;
                        clearInterval(this.timerInterval);
                        return;
                    }
                }, 1000);
            },
            stopTimer: function() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
            },
            resetNightData: function() {
                this.tonight = {
                    killTag: {},
                    killbyHunter: '',
                    killbyWerewolvesKing: '',
                    killedByWerewolves: '',
                    killedByWitch: '',
                    haveUsedAntidote: false,
                    verifyTarget: '',
                    verifyResult: '',
                };
            },
            resetDayData: function() {
                this.today = {
                    killbyHunter: '',
                    killbyWerewolvesKing: '',
                    firstSpeak: '',
                    speakIndex: 0,
                    speakingDirection: '', // left: 順時鐘, right: 逆時鐘
                    killedByVote: '',
                    PKRoundNum: 0,
                };
            },
            runDown: function() {
                var _this = this;
                var arr = [{
                        'messageHtml': '準備進入第' + _this.day + '夜',
                        'tipsHtml': '',
                        'action': function() {},
                    }, {
                        'messageHtml': '天黑請閉眼',
                        'tipsHtml': '',
                        'action': function() {
                            _this.stage = 'night';
                            _this.timeStatus = 'night';
                            _this.selectAutoNext = true;
                        }
                    }, {
                        'messageHtml': '狼人請睜眼<br>狼王請伸出大拇指',
                        'tipsHtml': '（請點選狼王玩家）',
                        'action': function() {
                            // 沒有設定狼王
                            if (_this.roleNum.werewolvesKing <= 0) {
                                return 'pass';
                            }
                            // 僅第一天需要
                            if (_this.day > 1) {
                                return 'pass';
                            }

                            var quota = _.get(_this, ['roleNum', 'werewolvesKing'], 0);
                            if (quota <= 0) {
                                throw 'Set werewolvesKing error: quota <= 0';
                            }

                            _this.setSelectQuota(quota);
                            _this.disableBtn = false;
                        },
                    }, {
                        'messageHtml': '狼人請睜眼<br>狼王請伸出大拇指',
                        'tipsHtml': '（請點選其他3名狼人玩家）',
                        'action': function() {
                            // 僅第一天需要
                            if (_this.day > 1) {
                                return 'pass';
                            }
                            if (_this.roleNum.werewolvesKing > 0) {
                                _this.setIdentity('werewolvesKing');
                                this.messageHtml = '狼人請睜眼<br>請確認彼此身份'
                                this.tipsHtml = '（請點選其他' + _this.roleNum.werewolves + '名狼人玩家）';
                            } else {
                                this.messageHtml = '狼人請睜眼'
                                this.tipsHtml = '（請點選' + _this.roleNum.werewolves + '名狼人玩家）';
                            }

                            var quota = _.get(_this, ['roleNum', 'werewolves'], 0);
                            if (quota <= 0) {
                                throw 'Set werewolves error: quota <= 0';
                            }
                            _this.setSelectQuota(quota);
                            _this.disableBtn = false;
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '（請點選被殺害玩家）',
                        'action': function() {
                            if (_this.day <= 1) {
                                this.messageHtml = '狼人請殺人';
                                _this.setIdentity('werewolves');
                            } else {
                                this.messageHtml = '狼人請睜眼<br>狼人請殺人';
                            }
                            _this.disableBtn = false;
                            _this.setSelectQuota(1);
                            _this.selectAutoNext = false;
                        },
                    }, {
                        'messageHtml': '狼人請閉眼',
                        'tipsHtml': '',
                        'action': function() {
                            _this.setKillTag('wolfKill');
                            _this.disableBtn = true;
                        },
                    }, {
                        'messageHtml': '女巫請睜眼',
                        'tipsHtml': '',
                        'action': function() {
                            // 沒有設定女巫
                            if (_this.roleNum.witch <= 0) {
                                return 'pass';
                            }

                            // 僅第一天需要
                            if (_this.day <= 1) {
                                var quota = _.get(_this, ['roleNum', 'witch'], 0);
                                if (quota <= 0) {
                                    throw 'Set witch error: quota <= 0';
                                }
                                this.tipsHtml = '（請點選女巫玩家）';
                                _this.setSelectQuota(quota);
                                _this.disableBtn = false;
                                _this.selectAutoNext = true;
                            }
                        },
                    }, {
                        'messageHtml': '他死了<br>請問你要使用解藥嗎？',
                        'tipsHtml': '',
                        'modal': '',
                        'action': function() {
                            // 沒有設定女巫
                            if (_this.roleNum.witch <= 0) {
                                return 'pass';
                            }

                            if (_this.day <= 1) {
                                _this.setIdentity('witch');
                            }

                            // 已使用解藥
                            if (_this.isUsedAntidote) {
                                return 'pass';
                            }

                            var theDead = _.findKey(_this.tonight.killTag, (o) => {
                                return o != '';
                            });

                            var witchPlayerKey = _.findKey(_this.players, (player) => {
                                return player == _this.witchPlayer;
                            });

                            this.tipsHtml = '（請用手勢告知 ' + theDead + '號 死亡）';

                            if (theDead == witchPlayerKey) {
                                if (_this.witchSelfHelpCon == WITCH_SELF_HELP_CON.ONLY_FIRST && _this.day > 1) {
                                    this.tipsHtml += '<br><span style="font-size: 0.9rem;">第一夜後不可自救</span>'
                                    return;
                                } else if (_this.witchSelfHelpCon == WITCH_SELF_HELP_CON.CAN_NOT) {
                                    this.tipsHtml += '<br><span style="font-size: 0.9rem;">不可自救</span>'
                                    return;
                                }
                            }

                            if (_.get(_this, ['witchPlayer', 'isAlive'], false) == true) {
                                this.modal = 'usedAntidote';
                            } else {
                                this.tipsHtml = '（念完即可）<br><span style="font-size: 0.9rem;">女巫已出局</span>';
                                _this.disableNext = false;
                                return;
                            }

                            _this.disableBtn = true;
                            _this.disableNext = true;
                        }
                    }, {
                        'messageHtml': '請問你要使用毒藥嗎？<br>你要毒誰呢？',
                        'tipsHtml': '',
                        'modal': '',
                        'action': function() {
                            _this.selectAutoNext = false;
                            // 沒有設定女巫
                            if (_this.roleNum.witch <= 0) {
                                return 'pass';
                            }

                            if (_this.tonight.haveUsedAntidote) {
                                _this.isUsedAntidote = true;
                                _this.tonight.killTag = {};
                            }

                            if (_.get(_this, ['witchPlayer', 'isAlive'], false) == false) {
                                this.tipsHtml = '（念完即可）<br><span style="font-size: 0.9rem;">女巫已出局</span>';
                                _this.disableNext = false;
                                return;
                            }

                            if (_this.tonight.haveUsedAntidote) {
                                this.tipsHtml = '（念完即可）<br><span style="font-size: 0.9rem;">無法同一夜使用解藥毒藥</span>';
                                _this.disableNext = false;
                                return;
                            }
                            if (_this.isUsedPoison) {
                                this.tipsHtml = '（念完即可）<br><span style="font-size: 0.9rem;">已無毒藥</span>';
                                _this.disableNext = false;
                                return;
                            }
                            this.tipsHtml = '（請點選毒藥使用玩家）';
                            _this.disableBtn = false;
                            _this.disableNext = true;
                            // (女巫已淘汰，念完即可)
                        }
                    }, {
                        'messageHtml': '女巫請閉眼',
                        'tipsHtml': '',
                        'action': function() {
                            // 沒有設定女巫
                            if (_this.roleNum.witch <= 0) {
                                return 'pass';
                            }
                            _this.setKillTag('witchKill', true);
                            _this.disableBtn = true;
                            _this.disableNext = false;
                        }
                    }, {
                        'messageHtml': '預言家請睜眼',
                        'tipsHtml': '',
                        'action': function() {
                            // 沒有設定預言家
                            if (_this.roleNum.seer <= 0) {
                                return 'pass';
                            }
                            // 僅第一天需要
                            if (_this.day <= 1) {
                                var quota = _.get(_this, ['roleNum', 'seer'], 0);
                                if (quota <= 0) {
                                    throw 'Set seer error: quota <= 0';
                                }
                                this.tipsHtml = '（請點選預言家玩家）';
                                _this.setSelectQuota(quota);
                                _this.disableBtn = false;
                                _this.selectAutoNext = true;
                            }
                        },
                    }, {
                        'messageHtml': '請選擇你要查驗的對象',
                        'tipsHtml': '（請點選被查驗對象）',
                        'action': function() {
                            // 沒有設定預言家
                            if (_this.roleNum.seer <= 0) {
                                return 'pass';
                            }
                            if (_this.day <= 1) {
                                _this.setIdentity('seer');
                            }
                            if (_.get(_this, ['seerPlayer', 'isAlive'], false) != true) {
                                this.tipsHtml = '（念完即可）<br><span style="font-size: 0.9rem;">預言家已淘汰</span>';
                                return;
                            }

                            _this.disableBtn = false;
                            _this.selectAutoNext = false;
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '（請用手勢告知身份）',
                        'action': function() {
                            // 沒有設定預言家
                            if (_this.roleNum.seer <= 0) {
                                return 'pass';
                            }
                            if (_.get(_this, ['seerPlayer', 'isAlive'], false) != true) {
                                return 'pass';
                            }
                            _this.seerVerify();
                            this.messageHtml = _this.tonight.verifyResult === 'good' ?
                                '<i class="bi bi-hand-thumbs-up-fill"></i>' : '<i class="bi bi-hand-thumbs-down-fill"></i>';
                            _this.disableBtn = true;
                            logArr.push('預言家驗證' + _this.selected[0] + '號' + logLang[_this.tonight.verifyResult]);
                            _this.selected = [];
                        }
                    }, {
                        'messageHtml': '預言家請閉眼',
                        'tipsHtml': '',
                        'action': function() {
                            // 沒有設定預言家
                            if (_this.roleNum.seer <= 0) {
                                return 'pass';
                            }
                        }
                    }, {
                        'messageHtml': '獵人請睜眼',
                        'tipsHtml': '（請點選獵人玩家）',
                        'action': function() {
                            // 沒有設定獵人
                            if (_this.roleNum.hunter <= 0) {
                                return 'pass';
                            }
                            if (_this.day > 1) {
                                return 'pass';
                            }

                            // 僅第一天需要
                            var quota = _.get(_this, ['roleNum', 'hunter'], 0);
                            if (quota <= 0) {
                                throw 'Set hunter error: quota <= 0';
                            }
                            _this.setSelectQuota(quota);
                            _this.disableBtn = false;
                            _this.selectAutoNext = true;
                        },
                    }, {
                        'messageHtml': '獵人請閉眼',
                        'tipsHtml': '',
                        'action': function() {
                            // 沒有設定獵人
                            if (_this.roleNum.hunter <= 0) {
                                return 'pass';
                            }
                            if (_this.day > 1) {
                                return 'pass';
                            }
                            _this.setIdentity('hunter');
                            _this.disableBtn = true;
                        },
                    }, {
                        'messageHtml': '騎士請睜眼',
                        'tipsHtml': '（請點選騎士玩家）',
                        'action': function() {
                            // 沒有設定騎士
                            if (_this.roleNum.knight <= 0) {
                                return 'pass';
                            }
                            if (_this.day > 1) {
                                return 'pass';
                            }
                            // 僅第一天需要
                            var quota = _.get(_this, ['roleNum', 'knight'], 0);
                            if (quota <= 0) {
                                throw 'Set hunter error: quota <= 0';
                            }
                            _this.setSelectQuota(quota);
                            _this.disableBtn = false;
                        },
                    }, {
                        'messageHtml': '騎士請閉眼',
                        'tipsHtml': '',
                        'action': function() {
                            // 沒有設定騎士
                            if (_this.roleNum.knight <= 0) {
                                return 'pass';
                            }
                            if (_this.day > 1) {
                                return 'pass';
                            }
                            _this.setIdentity('knight');
                            _this.disableBtn = true;
                        },
                    }, {
                        'messageHtml': '天亮了',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.day <= 1) {
                                _this.setCity();
                            }
                            _this.selectAutoNext = false;
                            _this.timeStatus = 'day';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            _this.executeKillTag();
                            _this.tonight.killTag = {};
                            if (_this.tonight.haveUsedAntidote) {
                                this.messageHtml = '昨晚是平安夜';
                            } else {
                                this.messageHtml = '昨晚 ' + _.filter([
                                    _this.tonight.killedByWerewolves,
                                    _this.tonight.killedByWitch,
                                ], function(killed) {
                                    return killed !== '';
                                }).sort(function(a, b) {
                                    return a - b;
                                }).join('號、') + '號 玩家出局';
                            }

                        },
                    },
                    //夜晚 狼刀到獵人
                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            var theDead = _.get(_this, ['tonight', 'killedByWerewolves'], '');
                            if (theDead == '' || _.get(_this, ['players', theDead, 'identity']) !== 'hunter') {
                                return 'pass';
                            }
                            this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                            this.tipsHtml = '（請點選技能使用對象）';
                            _this.disableBtn = false;
                            _this.stage = 'usingSkill';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.passSkillFlag) {
                                _this.stage = 'day';
                                this.messageHtml = _.get(_this, ['tonight', 'killedByWerewolves'], '') + '號玩家不使用技能';
                                _this.passSkillFlag = false;
                                return;
                            }
                            var theDead = _.get(_this, ['tonight', 'killedByWerewolves'], '');
                            if (theDead == '' || _.get(_this, ['players', theDead, 'identity']) !== 'hunter') {
                                return 'pass';
                            }
                            this.messageHtml = _this.selected[0] + '號玩家出局';
                            _this.hunterKill('night');
                            _this.stage = 'day';
                        },
                    },
                    // 獵槍殺到狼王case
                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            var theDead = _this.tonight.killbyHunter;
                            if (theDead == '' || _this.players[theDead].identity !== 'werewolvesKing') {
                                return 'pass'
                            }
                            this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                            this.tipsHtml = '（請點選技能使用對象）';
                            _this.disableBtn = false;
                            _this.stage = 'usingSkill';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.passSkillFlag) {
                                _this.stage = 'day';
                                this.messageHtml = _this.tonight.killbyHunter + '號玩家不使用技能';
                                _this.passSkillFlag = false;
                                return;
                            }
                            var theDead = _this.tonight.killbyHunter;
                            if (theDead == '' || _this.players[theDead].identity !== 'werewolvesKing') {
                                return 'pass'
                            }
                            this.messageHtml = _this.selected[0] + '號玩家出局';
                            _this.werewolvesKingKill('day');
                            _this.stage = 'day';
                        },
                    },
                    // 夜晚 狼王自刀
                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            var theDead = _.get(_this, ['tonight', 'killedByWerewolves'], '');
                            if (theDead == '' || _.get(_this, ['players', theDead, 'identity']) !== 'werewolvesKing') {
                                return 'pass';
                            }
                            this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                            this.tipsHtml = '（請點選技能使用對象）';
                            _this.disableBtn = false;
                            _this.stage = 'usingSkill';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.passSkillFlag) {
                                _this.stage = 'day';
                                this.messageHtml = _.get(_this, ['tonight', 'killedByWerewolves'], '') + '號玩家不使用技能';
                                _this.passSkillFlag = false;
                                return;
                            }
                            var theDead = _.get(_this, ['tonight', 'killedByWerewolves'], '');
                            if (theDead == '' || _.get(_this, ['players', theDead, 'identity']) !== 'werewolvesKing') {
                                return 'pass';
                            }
                            this.messageHtml = _this.selected[0] + '號玩家出局';
                            _this.werewolvesKingKill('night');
                            _this.stage = 'day';
                        },
                    },
                    // 狼王殺到獵人 case
                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            var theDead = _this.tonight.killbyWerewolvesKing;
                            if (theDead == '' || _this.players[theDead].identity !== 'hunter') {
                                return 'pass'
                            }
                            this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                            this.tipsHtml = '（請點選技能使用對象）';
                            _this.disableBtn = false;
                            _this.stage = 'usingSkill';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.passSkillFlag) {
                                _this.stage = 'day';
                                this.messageHtml = _this.tonight.killbyWerewolvesKing + '號玩家不使用技能';
                                _this.passSkillFlag = false;
                                return;
                            }
                            var theDead = _this.tonight.killbyWerewolvesKing;
                            if (theDead == '' || _this.players[theDead].identity !== 'hunter') {
                                return 'pass'
                            }
                            this.messageHtml = _this.selected[0] + '號玩家出局';
                            _this.hunterKill('day');
                            _this.stage = 'day';
                        },
                    }, {
                        'messageHtml': '請發表遺言',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.day > 1 || _this.tonight.haveUsedAntidote) {
                                return 'pass';
                            }
                        },
                    }, {
                        'messageHtml': '由系統抽出發言順序',
                        'tipsHtml': '',
                        'action': function() {
                            _this.disableBtn = true;
                            _this.selected = [];
                            _this.randomOrder();
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            _this.stage = 'speaking';
                            var totalPlayers = _.size(_this.players);
                            var direction = _this.today.speakingDirection == 'left' ? '順時針' : '逆時針';
                            var next = (_this.today.speakingDirection == 'left' ? (_this.today.firstSpeak + 1) : (_this.today.firstSpeak - 1));
                            this.messageHtml = '由' + _this.today.firstSpeak + '號玩家開始<br>往' + direction + '方向接續';
                        },
                    }, {
                        'messageHtml': '現在準備投票',
                        'tipsHtml': '',
                        'action': function() {
                            _this.showTimer = false;
                        },
                    }, {
                        'messageHtml': '3、2、1 請投票',
                        'tipsHtml': '（請點選遭投票出局玩家）',
                        'action': function() {
                            _this.disableBtn = false;
                            _this.stage = 'voting';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.clickPKFlag) {
                                _this.today.PKRoundNum += 1;
                                _this.clickPKFlag = false;
                            }
                            if (_this.today.PKRoundNum == 1) {
                                this.messageHtml = '進行辯論<br>請平票候選人依序發言';
                                _this.disableBtn = false;
                                logArr.push('平票辯論');
                                _this.stage = 'PKSpeaking';
                                return;
                            }
                            this.messageHtml = _this.selected[0] + '號玩家出局';
                            _this.voteKill();
                            _this.stage = 'day';
                        },
                    },
                    // 平票PK
                    {
                        'messageHtml': '再次準備投票',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.today.PKRoundNum == 1) {
                                return;
                            }
                            return 'pass';
                        },
                    }, {
                        'messageHtml': '3、2、1 請投票',
                        'tipsHtml': '（請點選遭投票出局玩家）',
                        'action': function() {
                            if (_this.today.PKRoundNum == 1) {
                                _this.disableBtn = false;
                                _this.stage = 'voting';
                                return;
                            }
                            return 'pass';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.clickPKFlag) {
                                _this.today.PKRoundNum += 1;
                                _this.clickPKFlag = false;
                            }
                            if (_this.today.PKRoundNum == 1) {
                                this.messageHtml = _this.selected[0] + '號玩家出局';
                                _this.voteKill();
                                _this.stage = 'day';
                            } else {
                                return 'pass';
                            }
                        },
                    },
                    //票到獵人或狼王 strat
                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            var theDead = _.get(_this, ['today', 'killedByVote'], '');
                            var theDeadIdentity = _.get(_this, ['players', theDead, 'identity'], '');

                            if (theDeadIdentity === 'hunter' ||
                                theDeadIdentity === 'werewolvesKing') {
                                this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                                this.tipsHtml = '（請點選技能使用對象）';
                                _this.disableBtn = false;
                                _this.stage = 'usingSkill';
                                return;
                            }
                            return 'pass';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.passSkillFlag) {
                                _this.stage = 'day';
                                this.messageHtml = _.get(_this, ['today', 'killedByVote'], '') + '號玩家不使用技能';
                                _this.passSkillFlag = false;
                                return;
                            }
                            var theDead = _.get(_this, ['today', 'killedByVote'], '');
                            var theDeadIdentity = _.get(_this, ['players', theDead, 'identity'], '');

                            this.messageHtml = _this.selected[0] + '號玩家出局';
                            if (theDeadIdentity === 'hunter') {
                                _this.hunterKill('day');
                                _this.stage = 'day';
                                return;
                            } else if (theDeadIdentity === 'werewolvesKing') {
                                _this.werewolvesKingKill('day');
                                _this.stage = 'day';
                                return;
                            }
                            return 'pass';
                        },
                    }, {
                        //又殺到狼王或獵人＊＊＊＊＊＊＊＊＊＊＊＊＊
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.today.killbyHunter != '') {
                                var theDead = _this.today.killbyHunter;
                                if (_.get(_this, ['players', theDead, 'identity'], '') === 'werewolvesKing') {
                                    this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                                    this.tipsHtml = '（請點選技能使用對象）';
                                    _this.disableBtn = false;
                                    _this.stage = 'usingSkill';
                                    return;
                                }
                            }
                            if (_this.today.killbyWerewolvesKing != '') {
                                var theDead = _this.today.killbyWerewolvesKing;
                                if (_.get(_this, ['players', theDead, 'identity'], '') === 'hunter') {
                                    this.messageHtml = theDead + '號玩家<br>請使用角色技能';
                                    this.tipsHtml = '（請點選技能使用對象）';
                                    _this.disableBtn = false;
                                    _this.stage = 'usingSkill';
                                    return;
                                }
                            }
                            return 'pass';
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.today.killbyHunter != '') {
                                var theDead = _this.today.killbyHunter;
                                if (_.get(_this, ['players', theDead, 'identity'], '') === 'werewolvesKing') {
                                    if (_this.passSkillFlag) {
                                        _this.stage = 'day';
                                        this.messageHtml = theDead + '號玩家不使用技能';
                                        _this.passSkillFlag = false;
                                        return;
                                    }

                                    this.messageHtml = _this.selected[0] + '號玩家出局';
                                    _this.werewolvesKingKill('day');
                                    _this.stage = 'day';
                                    return;
                                }
                            }
                            if (_this.today.killbyWerewolvesKing != '') {
                                var theDead = _this.today.killbyWerewolvesKing;
                                if (_.get(_this, ['players', theDead, 'identity'], '') === 'hunter') {
                                    if (_this.passSkillFlag) {
                                        _this.stage = 'day';
                                        this.messageHtml = theDead + '號玩家不使用技能';
                                        _this.passSkillFlag = false;
                                        return;
                                    }

                                    this.messageHtml = _this.selected[0] + '號玩家出局';
                                    _this.hunterKill('day');
                                    _this.stage = 'day';
                                    return;
                                }
                            }
                            return 'pass';
                        },
                    },
                    //票到獵人或狼王 end
                    {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            if (_this.today.killedByVote == '' && _this.today.PKRoundNum == 2) {
                                this.messageHtml = '再次平票，進入黑夜'
                            } else {
                                this.messageHtml = '請發表遺言'
                            }
                            _this.stage = 'day';
                            _this.disableBtn = true;
                        },
                    }, {
                        'messageHtml': '',
                        'tipsHtml': '',
                        'action': function() {
                            _this.actionNum = 0;
                            _this.day += 1;
                            _this.resetNightData();
                            _this.resetDayData();
                        },
                    },
                ];

                console.log(arr.length);
                return arr[this.actionNum];
            },

        },
        computed: {
            knightBattleDisable: function() {
                // 有bug
                return this.knightIsUsedSkill || !_.get(this, ['knightPlayer', 'isAlive'], false);
            },
            seerPlayer: function() {
                return _.find(this.players, (player) => {
                    return player.identity == 'seer';
                });
            },
            knightPlayer: function() {
                return _.find(this.players, (player) => {
                    return player.identity == 'knight';
                });
            },
            witchPlayer: function() {
                return _.find(this.players, (player) => {
                    return player.identity == 'witch';
                });
            },
            functionBarBtns: function() {
                var _this = this;
                return [{
                        class: 'function-btn',
                        click: () => {
                            _this.showModal = 'knightBattle';
                        },
                        disable: _this.knightBattleDisable,
                        html: '騎士查驗',
                        isShow: !(_this.stage == 'voting' || _this.stage == 'usingSkill')
                    },

                    {
                        class: 'function-btn',
                        click: () => {
                            _this.showModal = 'wolfKillSelf';
                        },
                        disable: false,
                        html: '狼人自爆',
                        isShow: !(_this.stage == 'voting' || _this.stage == 'usingSkill')
                    }, {
                        class: 'function-btn special',
                        click: _this.pkRound,
                        disable: false,
                        html: _this.today.PKRoundNum == 0 ? '票數相同 進行辯論' : '票數再次相同 進入黑夜',
                        isShow: _this.stage == 'voting',
                    }, {
                        class: 'function-btn special',
                        click: () => {
                            _this.passSkillFlag = true;
                            _this.next();
                        },
                        disable: false,
                        html: '不使用技能',
                        isShow: _this.stage == 'usingSkill'
                    }
                ];
            },
        }
    })
</script>